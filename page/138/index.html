<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/08/13/build-nbd-kernel-module-on-centos7/>Build nbd Kernel Module On CentOS7</a></h1><span class=post-date>Aug 13, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=get-source-code>Get Source Code</h3><p>First check your kernel version via:</p><pre><code>$ uname -r
3.10.0-229.7.2.el7.x86_64
</code></pre><p>Then find the corresponding kernel source rpm under vault.centos.org, download its rpm
and install it.</p><pre><code>$ wget http://vault.centos.org/7.1.1503/updates/Source/SPackages/kernel-3.10.0-229.7.2.el7.src.rpm
# useradd builder
# groupadd builder
$ rpm -ivh kernel-3.10.0-229.7.2.el7.src.rpm
</code></pre><h3 id=build-preparation>Build Preparation</h3><p>As a normal user, do following:</p><pre><code>$ mkdir -p ~/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
$ echo '%_topdir %(echo $HOME)/rpmbuild' &gt; ~/.rpmmacros
$ cd ~/rpmbuild/SPECS
$ rpmbuild -bp --target=$(uname -m) kernel.spec
$ cd ~/rpmbuild/BUILD/kernel-3.10.0-229.7.2.el7/linux-3.10.0-229.7.2.el7.centos.x86_64/
$ ls
arch     COPYING  Documentation  fs       ipc      kernel       Makefile  README          scripts   tools
block    CREDITS  drivers        include  Kbuild   lib          mm        REPORTING-BUGS  security  usr
configs  crypto   firmware       init     Kconfig  MAINTAINERS  net       samples         sound     virt
</code></pre><p>Now the source code tree is available.</p><h3 id=build>Build</h3><p>In the kernel source directory, type <code>make menuconfig</code> for configurating the kernel
configuration, select :</p><p>Device Driver -> Block devices -> Set &ldquo;M&rdquo; On &ldquo;Network block device support&rdquo;</p><p>Save the configuration and exit, now begin to make via:</p><pre><code>$ make prepare &amp;&amp; make modules_prepare &amp;&amp; make
</code></pre><p>Now makeout the kernel module and copy it to modules directory:</p><pre><code>$ make M=drivers/block -j8
$ modinfo drivers/block/nbd.ko
$ sudo cp drivers/block/nbd.ko /lib/modules/3.10.0-229.7.2.el7.x86_64/extra/
$ sudo depmod -a &amp;&amp; sudo modprobe nbd
</code></pre><p>Finally met some problems of nbd, don&rsquo;t know why, later will debug on.</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/08/13/automatically-create-virtual-machine/>Automatically Create Virtual Machine</a></h1><span class=post-date>Aug 13, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>Just record the whole scripts for create/define/start the vm machine.</p><pre><code>#!/bin/bash
# $1: The name of the virtual machine. 

### 1. Check Input Parameters. 
if [ $# != 1 ]
then
  echo &quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;
  echo &quot;!!         Parameters error       !!&quot;
  echo &quot;!! Example: ./createvm.sh name    !!&quot;
  echo &quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;
  exit 1
fi

### 2. Create the qcow2 file in local directory. 
echo $1
qemu-img create -f qcow2 -b /home/juju/img/WolfHunter/SpaceWalk/Base/packer-ubuntu-1204-server-i386 $1.qcow2

### 3. Generate Random MAC Address.
printf -v macaddr &quot;52:54:%02x:%02x:%02x:%02x&quot; $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff )) $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff ))
# echo $macaddr
### 3.1 Check whether this MAC Address is in the host's existing items. 
declare maclist

### 3.2 Get the MAC Address List
for vm in $(virsh list --all | tail -n +3 |  awk '{print $2}')
do
        # Multiple NIC need this. 
    for mac_item in $(virsh dumpxml $vm | grep &quot;mac address&quot; | awk -F &quot;'&quot; '{print $2}')
                do
                        # echo $mac_item
                        maclist+=($mac_item)
                done
done

# echo ${maclist[*]} 
# echo ${#maclist[@]}

### 3.3 Processing possible duplicated problem. 
### We don't hope the generate random mac address to be duplicated, so write whatever you want to see under the while loop for debugging
### Judge if the generated random mac address duplicated. 
while [[ ${maclist[*]} =~ ${macaddr} ]]
do
        echo &quot;yes, you entered while for changing the mac address!&quot;
        printf -v macaddr &quot;52:54:%02x:%02x:%02x:%02x&quot; $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff )) $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff ))
        echo $macaddr
done

### 3.4 Only for debugging purpose, view result
### For debugging purpose
### if [[ ${maclist[*]} =~ ${macaddr} ]]
### then
###     echo &quot;Yes, it's in the existing mac list&quot;
### else
###     echo &quot;Congratulations, it's safe to use this mac!&quot;
### fi
### echo $macaddr

### 4. Create new xml file and modify the xml file.
### 4.1 Create the file
mkdir -p xml
cp ./Template.xml ./xml/$1.xml
### 4.2 Remove the uuid(Virt-manager will automatically generate it)
sed -i '/uuid/d' ./xml/$1.xml
### 4.3 Replace the MAC Address
sed -i -r &quot;s/(.*)([a-zA-Z0-9]{2}:[a-zA-Z0-9]{2}:[a-zA-Z0-9]{2}:[a-zA-Z0-9]{2}:[a-zA-Z0-9]{2}:[a-zA-Z0-9]{2})(.*)/\1$macaddr\3/g&quot; ./xml/$1.xml 
### 4.4 Replace the virt disk file
imagepath=($PWD/$1.qcow2)
echo $imagepath
sed -i &quot;s#&lt;source file.*#&lt;source file='$imagepath'/&gt;#g&quot;  ./xml/$1.xml

### 5. Change the VM Name
sed -i &quot;s#&lt;name.*#&lt;name&gt;$1&lt;/name&gt;#g&quot; ./xml/$1.xml

### 6. Define and Start VM Machine
virsh define $PWD/xml/$1.xml
virsh start $1

</code></pre><p>Steps for create the machine:</p><pre><code># ./createvm.sh zz_bee1
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/08/12/create-channel-slash-repository-in-spacewalk/>Create Channel/Repository In SpaceWalk</a></h1><span class=post-date>Aug 12, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=package-preparation>Package Preparation</h3><p>First you should enable the repository via:</p><pre><code># wget http://yum.spacewalkproject.org/2.3/RHEL/6/x86_64/spacewalk-repo-2.3-4.el6.noarch.rpm
# rpm -ivh spacewalk-repo-2.3-4.el6.noarch.rpm
# vim /etc/yum.repos.d/jpackage-repo.repo 
[jpackage-generic]
name=JPackage generic
#baseurl=http://mirrors.dotsrc.org/pub/jpackage/5.0/generic/free/
mirrorlist=http://www.jpackage.org/mirrorlist.php?dist=generic&amp;type=free&amp;release=5.0
enabled=1
gpgcheck=1
gpgkey=http://www.jpackage.org/jpackage.asc
</code></pre><p>Install the <code>spacewalk-remote-utils</code> package:</p><pre><code># yum install -y spacewalk-remote-utils
</code></pre><h3 id=webui-create-repository>WebUI Create Repository</h3><p>Create an ia32-debian based channel, in WebUI:</p><p><img src=/images/2015_08_12_17_22_47_651x391.jpg alt=/images/2015_08_12_17_22_47_651x391.jpg></p><p>Continue to create some child channel:</p><p><img src=/images/2015_08_12_17_26_22_810x155.jpg alt=/images/2015_08_12_17_26_22_810x155.jpg></p><p>Now create the repository like following:</p><p><img src=/images/2015_08_12_17_28_41_796x426.jpg alt=/images/2015_08_12_17_28_41_796x426.jpg></p><p>Until you created all of the ia32 based repositories:</p><p><img src=/images/2015_08_12_17_30_39_609x115.jpg alt=/images/2015_08_12_17_30_39_609x115.jpg></p><p>Associate the repository with channels.</p><h3 id=sync-repositories>Sync Repositories</h3><p>Use following scripts for syncing the packages into the system:</p><pre><code># vim precise-update.sh 
until spacewalk-debian-sync.pl --username xxxxx --password xxxx --channel 'precise-ia32-updates' --url 'http://192.168.0.79/ubuntu/dists/precise-updates/main/binary-i386/'
do
        echo &quot;retry again&quot;
        sleep 30
done
# sh precise-update.sh
INFO: Repo URL: http://192.168.0.79/ubuntu/dists/precise-updates/main/binary-i386/
INFO: Ubuntu root is http://192.168.0.79/ubuntu/
INFO: Fetching Packages.gz... done
........
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/08/12/trouble-shooting-on-spacewalk-osad-on-ubuntu-clients/>Trouble Shooting On SpaceWalk OSAD On Ubuntu Clients</a></h1><span class=post-date>Aug 12, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=problem>Problem</h3><p>On Clients(Ubuntu nodes), you will see lots of the following message in
<code>/var/log/osad</code>:</p><pre><code>$ tail /var/log/osad
2015-08-11 19:31:14 jabber_lib.main: Unable to connect to jabber servers, sleeping 78 seconds
2015-08-11 19:32:32 jabber_lib.main: Unable to connect to jabber servers, sleeping 117 seconds
</code></pre><p>When restart the osda service you will see following error message:</p><pre><code># service osad restart
OSAD SpaceWalk Deamon osad                                                     Traceback (most recent call last):
  File &quot;/usr/share/rhn/osad/jabber_lib.py&quot;, line 252, in setup_connection
    c = self._get_jabber_client(js)
  File &quot;/usr/share/rhn/osad/jabber_lib.py&quot;, line 309, in _get_jabber_client
    c.connect()
  File &quot;/usr/share/rhn/osad/jabber_lib.py&quot;, line 583, in connect
    self.disconnect()
  File &quot;/usr/share/rhn/osad/jabber_lib.py&quot;, line 653, in disconnect
    jabber.Client.disconnect(self)
  File &quot;/usr/lib/python2.7/dist-packages/jabber/jabber.py&quot;, line 432, in disconnect
    xmlstream.Client.disconnect(self)
  File &quot;/usr/lib/python2.7/dist-packages/jabber/xmlstream.py&quot;, line 388, in disconnect
    while self.process(): pass
  File &quot;/usr/share/rhn/osad/jabber_lib.py&quot;, line 1059, in process
    raise JabberError(&quot;Premature EOF&quot;)
JabberError: Premature EOF
</code></pre><p>Though seeing this error, your osad will start and running, but with errors.</p><h3 id=trouble-shooting>Trouble Shooting</h3><p>Make sure the port 5222 and 5269 of spacewalk server are telnet-able from client machine:</p><pre><code>adminubuntu@spacewalknode1:~$ telnet spacewalk 5222
Trying 10.11.11.3...
Connected to spacewalk.
Escape character is '^]'.
^]
telnet&gt; quit
Connection closed.
adminubuntu@spacewalknode1:~$ telnet spacewalk 5269
Trying 10.11.11.3...
Connected to spacewalk.
Escape character is '^]'.
^]
telnet&gt; 
</code></pre><p>Make sure you register yourself on client using FQDN but not the IP Address:</p><pre><code># rhnreg_ks --activationkey=1-precise --serverUrl=http://spacewalk/XMLRPC --force
# service osad restart
</code></pre><p>If by this you won&rsquo;t pass the osad check, you should setup the local dns server, which
enable name resolve of <code>spacewalk</code>, you could take following article for reference:<br><a href=http://purplepalmdash.github.io/blog/2015/08/05/enable-dhcp-slash-dns-server-for-spacewalker-server/>http://purplepalmdash.github.io/blog/2015/08/05/enable-dhcp-slash-dns-server-for-spacewalker-server/</a></p><p>For checking the dns resole, run following command on client:</p><pre><code>adminubuntu@spacewalknode1:~$ dig spacewalk

; &lt;&lt;&gt;&gt; DiG 9.8.1-P1 &lt;&lt;&gt;&gt; spacewalk
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 16045
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 0

;; QUESTION SECTION:
;spacewalk.                     IN      A

;; ANSWER SECTION:
spacewalk.              604800  IN      A       10.11.11.3

;; AUTHORITY SECTION:
spacewalk.              604800  IN      NS      spacewalk.

;; Query time: 2 msec
;; SERVER: 10.11.11.3#53(10.11.11.3)
;; WHEN: Wed Aug 12 03:34:18 2015
;; MSG SIZE  rcvd: 57
</code></pre><h3 id=result>Result</h3><p>After resolving this problem, your log should like this:</p><p>On Server:</p><pre><code>$ tail /var/log/message
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] [::ffff:10.11.11.100, port=45486] connect
Aug 12 10:34:50 spacewalk named[993]: error (network unreachable) resolving 'ns4.p27.dynect.net/A/IN': 2001:500:94::100#53
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] created user: user=osad-c942811c1c; realm=
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] registration succeeded, requesting user creation: jid=osad-c942811c1c@spacewalk
Aug 12 10:34:50 spacewalk jabberd/sm[1371]: created user: jid=osad-c942811c1c@spacewalk
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] legacy authentication succeeded: host=, username=osad-c942811c1c, resource=osad, TLS negotiated
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] requesting session: jid=osad-c942811c1c@spacewalk/osad
Aug 12 10:34:50 spacewalk jabberd/sm[1371]: session started: jid=osad-c942811c1c@spacewalk/osad
</code></pre><p>In SpaceWalk backend you will see:</p><p><img src=/images/2015_08_12_11_37_48_538x222.jpg alt=/images/2015_08_12_11_37_48_538x222.jpg><br>Now you could direct <code>push</code> your modification to clients in SpaceWalk backend.</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/08/11/added-precise-repository-in-spacewalk/>Added Precise Repository In SpaceWalk</a></h1><span class=post-date>Aug 11, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=spacewalk-backend-configruation>SpaceWalk Backend Configruation</h3><p>First Create the Channel:<br><img src=/images/2015_08_11_16_27_35_420x157.jpg alt=/images/2015_08_11_16_27_35_420x157.jpg><br>Then Create the Repository like following:<br><img src=/images/2015_08_11_16_28_21_562x226.jpg alt=/images/2015_08_11_16_28_21_562x226.jpg><br>Associate the channel together with repository:<br><img src=/images/2015_08_11_16_29_33_659x385.jpg alt=/images/2015_08_11_16_29_33_659x385.jpg></p><h3 id=install-packages>Install packages</h3><p>Do following for the prerequisition for syncing the repository.</p><pre><code># yum update python-debian
# vim  /usr/lib/python2.6/site-packages/debian/debfile.py 
PART_EXTS = ['gz', 'xz', 'lzma']
# wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
# rpm -ivh epel-release-6-8.noarch.rpm
# cat epel-testing.repo  | more
[epel-testing]
name=Extra Packages for Enterprise Linux 6 - Testing - $basearch
#baseurl=http://download.fedoraproject.org/pub/epel/testing/6/$basearch
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=testing-epel6&amp;arch=$basearch
baseurl=http://mirrors.aliyun.com/epel/testing/6/x86_64/
failovermethod=priority
</code></pre><h3 id=sync-with-local-repository>Sync With Local Repository</h3><p>An example of precise-backports is listed like following, take this example for
example, create other 3 shell scripts:</p><pre><code># cat precise-backports.sh
until spacewalk-debian-sync.pl --username xxxxx --password xxxxxx --channel 'precise-backports' --url 'http://192.168.0.79/ubuntu/dists/precise-backports/main/binary-amd64/'
do
        echo &quot;retry again&quot;
        sleep 30
done
# ls *.sh
precise-backports.sh  precise-security.sh  precise.sh  precise-update.sh
</code></pre><p>Sync repository via <code>sh precise-backports.sh</code> or other scripts.</p><p>After a long while, you repository will be updated.</p></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/137/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/137/>137</a></li><li class="page-item active"><a class=page-link href=/page/138/>138</a></li><li class=page-item><a class=page-link href=/page/139/>139</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/240/>240</a></li><li class=page-item><a href=/page/139/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/240/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>