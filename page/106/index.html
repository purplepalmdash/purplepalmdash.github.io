<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2016/11/05/%E4%B8%BAblog%E6%B7%BB%E5%8A%A0%E4%BF%9D%E5%AD%98%E4%B8%BA%E5%9B%BE%E7%89%87%E5%8A%9F%E8%83%BD/>为Blog添加保存为图片功能</a></h1><span class=post-date>Nov 5, 2016<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=背景>背景</h3><p>众所周知疼讯其实一直是一个很封闭傻逼的企业，早年QZONE的代码就层层加密，
惟恐互联网爬虫爬到它上面取内容。进入到移动互联网时代，就更加变本加厉，盆友
圈里的诸多内容，恐怕诸位都是没办法弄出来的。</p><p>早年曾在Blog上添加过<code>分享到朋友圈</code>或<code>分享到微信好友</code>按钮，由于<code>github.io</code>未
被疼讯认可，共享出来的链接通常只有自己能看到，这又是一个拿用户当SB的典型
案例。</p><p>还好，对于用户上传图片，疼讯是没法限制的。所以有了以下的开发。</p><h3 id=功能参考>功能参考</h3><p>在博文里添加按钮<code>一键保存为图片</code>,即可将该篇文章生成为长图片。</p><p><img src=/images/2016_11_05_18_38_31_637x390.jpg alt=/images/2016_11_05_18_38_31_637x390.jpg></p><p>参考设计： 锤子便签。顺便吐槽一下锤子便签，添加了关键词过滤，关键词嘛，这也是
党国拿来折腾屁民的一个傻逼玩意，例如有一首歌是这么唱的:</p><pre><code>我爱北京关键词，
关键词上太阳升。。
伟大得领袖关键词，
带领我们向前进…
</code></pre><p>╮〔╯ε╰〕╭ &mdash;太多的关键词，容易让写博文的人心情不好。</p><h3 id=可选方案>可选方案</h3><p>A. wkhtmltoimage.<br>这个转换起来是全屏转换，所以最初想到的是对网页做再加工，抠取出其中含有内容的一部分。
好处是，真的是所见即所得。</p><pre><code>$ wkhtmltoimage http://www.google.com google.jpg
</code></pre><p>B. html2canvas.<br>这种方案直接在html页面上做文章，添加按钮后直接用画布来生成对象。缺点是有些格式显示出来
有少量阴影。</p><p>暂时基于方案B实现。</p><h3 id=code>Code</h3><p>参考资料:<br><a href="https://www.youtube.com/watch?v=-d2FeFiBvEo">https://www.youtube.com/watch?v=-d2FeFiBvEo</a><br><a href=https://html2canvas.hertzen.com/>https://html2canvas.hertzen.com/</a></p><p>因为本博客基于hugo构建，直接修改hugo使用的主题即可添加html2canvas。</p><p>目录结构:</p><pre><code>$ ls  
config.toml  content  id_rsa.enc  scripts  static  themes
$ themes/hyde-a
$ ls
archetypes  images  layouts  LICENSE  README.md  static  theme.toml
</code></pre><p>下载<code>html2canvas.js</code>到主题的<code>static/js</code>目录:</p><pre><code>$ cd static/js
$ wget
https://github.com/niklasvh/html2canvas/releases/download/0.4.1/html2canvas.js
</code></pre><p>在主题的<code>./layouts/partials/head.html</code>文件中添加所需要的js文件及javascript代码
, (+代表新添加代码):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>link</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;stylesheet&#34;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css&#34;</span><span style=color:#f92672>&gt;</span>
<span style=color:#f92672>+</span>  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>script</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text/javascript&#34;</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&#34;</span><span style=color:#f92672>&gt;</span><span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>s</span><span style=color:#960050;background-color:#1e0010>c</span><span style=color:#960050;background-color:#1e0010>r</span><span style=color:#960050;background-color:#1e0010>i</span><span style=color:#960050;background-color:#1e0010>p</span><span style=color:#960050;background-color:#1e0010>t</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
<span style=color:#f92672>+</span>  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>script</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text/javascript&#34;</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/js/html2canvas.js&#34;</span><span style=color:#f92672>&gt;</span><span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>s</span><span style=color:#960050;background-color:#1e0010>c</span><span style=color:#960050;background-color:#1e0010>r</span><span style=color:#960050;background-color:#1e0010>i</span><span style=color:#960050;background-color:#1e0010>p</span><span style=color:#960050;background-color:#1e0010>t</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
<span style=color:#f92672>+</span>  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>script</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;text/javascript&#39;</span><span style=color:#f92672>&gt;</span><span style=color:#75715e>//&lt;![CDATA[
</span><span style=color:#75715e></span><span style=color:#f92672>+</span>  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>genPostShot</span>() { 
<span style=color:#f92672>+</span>          <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>rightNow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
<span style=color:#f92672>+</span>          <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>imageName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>rightNow</span>.<span style=color:#a6e22e>toISOString</span>().<span style=color:#a6e22e>slice</span>(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>16</span>).<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/(-)|(:)|(T)/g</span>,<span style=color:#e6db74>&#34;&#34;</span>);
<span style=color:#f92672>+</span>          <span style=color:#a6e22e>imageName</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;.jpg&#39;</span>
<span style=color:#f92672>+</span>          <span style=color:#a6e22e>html2canvas</span>(document.<span style=color:#a6e22e>getElementsByClassName</span>(<span style=color:#e6db74>&#39;post&#39;</span>), {
<span style=color:#f92672>+</span>              <span style=color:#a6e22e>onrendered</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>canvas</span>) {
<span style=color:#f92672>+</span>  		<span style=color:#75715e>// Click them for download
</span><span style=color:#75715e></span><span style=color:#f92672>+</span>          	<span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#test&#39;</span>).<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;href&#39;</span>, <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>toDataURL</span>(<span style=color:#e6db74>&#34;image/jpeg&#34;</span>));
<span style=color:#f92672>+</span>          	<span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#test&#39;</span>).<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;download&#39;</span>,<span style=color:#a6e22e>imageName</span>);
<span style=color:#f92672>+</span>          	<span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#test&#39;</span>)[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>click</span>();
<span style=color:#f92672>+</span>              }
<span style=color:#f92672>+</span>          });
<span style=color:#f92672>+</span>  }; 
<span style=color:#f92672>+</span>  <span style=color:#75715e>//]]&gt;
</span><span style=color:#75715e></span><span style=color:#f92672>+</span>  <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>s</span><span style=color:#960050;background-color:#1e0010>c</span><span style=color:#960050;background-color:#1e0010>r</span><span style=color:#960050;background-color:#1e0010>i</span><span style=color:#960050;background-color:#1e0010>p</span><span style=color:#960050;background-color:#1e0010>t</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js&#34;</span><span style=color:#f92672>&gt;</span><span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>s</span><span style=color:#960050;background-color:#1e0010>c</span><span style=color:#960050;background-color:#1e0010>r</span><span style=color:#960050;background-color:#1e0010>i</span><span style=color:#960050;background-color:#1e0010>p</span><span style=color:#960050;background-color:#1e0010>t</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</code></pre></div><p>简单解释一下这几行代码：</p><ol><li>取当时UTC时间作为下载jpg文件名。</li><li>在当前页面中根据div的class名称找到<code>post</code>字段，构建一个画布。</li><li>将画布内容输出为jpeg文件，触发浏览器的一个下载动作。</li></ol><p><strong>注意</strong>: <code>#test</code>为在html文件中添加的一个不可见链接.</p><p>接下来修改每个博文用到的模板文件(layourts/post/single.html):</p><pre><code>{{ partial &quot;head.html&quot; . }}
&lt;div class=&quot;content container&quot;&gt;
  &lt;div class=&quot;post&quot;&gt;
    &lt;h1&gt;{{ .Title }}&lt;/h1&gt;
+    &lt;p align=&quot;right&quot;&gt;
+    &lt;a href=&quot;javascript:genPostShot()&quot;&gt;
+	    TurnToJPG --&gt; &lt;i class=&quot;fa fa-camera-retro fa-2x&quot;&gt;&lt;/i&gt;
+    &lt;/a&gt;
+    &lt;a id=&quot;test&quot;&gt;&lt;/a&gt;
+    &lt;/p&gt;
+    &lt;hr&gt;
    &lt;span class=&quot;post-date&quot;&gt;{{ .Date.Format &quot;Jan 2, 2006&quot; }} {{ if .Site.DisqusShortname }} &amp;middot; &lt;a href=&quot;{{ .Permalink }}#disqus_thread&quot;&gt;Comments&lt;/a&gt;{{ end }}
</code></pre><p>简单解释一下上述添加的代码:</p><p>添加一个超链接，指向上文定义的javascript函数<code>genPostShot()</code>.</p><p>保存修改，提交到上游仓库，重新生成整个静态网站，现在每个博文里都含有保存图片按钮。</p><h3 id=效果>效果</h3><p>譬如，点击<a href=http://purplepalmdash.github.io/2013/11/17/run-in-winter/>http://purplepalmdash.github.io/2013/11/17/run-in-winter/</a></p><p>效果如下:</p><p><img src=/images/2016_11_05_18_56_04_638x402.jpg alt=/images/2016_11_05_18_56_04_638x402.jpg></p><p>点击按钮，下载为文件201611051057.jpg(当前UTC时间戳），效果如下:</p><p><img src=/images/2016_11_05_18_58_11_250x375.jpg alt=/images/2016_11_05_18_58_11_250x375.jpg></p><p>打完，收工，以后在盆友圈想怎么咆哮就可以怎么咆哮了。</p><h3 id=trouble-shooting>Trouble-Shooting</h3><p>之所以加这么个条目是因为，在未定义背景的网页里，有时候截出来的图是黑色背景的，修正：</p><p>修改<code>./static/js/html2canvas.js</code>文件:</p><pre><code>sTransparent = function(backgroundColor) {
  return (backgroundColor === &quot;transparent&quot; || backgroundColor === &quot;rgba(0, 0,
0, 0)&quot;);
};
</code></pre><p>改为:</p><pre><code>_html2canvas.Util.isTransparent = function(backgroundColor) {
  return (backgroundColor === &quot;transparent&quot; || backgroundColor === &quot;rgba(0, 0,
0, 0)&quot; || backgroundColor === undefined);
};
</code></pre><p>之后我们在<code>./layouts/partials/head.html</code>中，添加这一行:</p><pre><code>          html2canvas(document.getElementsByClassName('post'), {
+              background :'#FFFFFF',
              onrendered: function(canvas) {
</code></pre><p>现在生成的图片背景就是白色的了。</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2016/11/04/setuparegistryproxycachefordocker/>SetupARegistryProxyCacheForDocker</a></h1><span class=post-date>Nov 4, 2016<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=准备>准备</h3><p>首先需要准备以下Docker image:</p><pre><code>$ sudo docker pull registry:latest
$ sudo docker pull registry:2
</code></pre><p>在<code>/etc/hosts</code>里加一条记录，接下来我们将用这条记录生成签名(注意修改IP地址和域名）:</p><pre><code># echo '192.168.0.121    xxx.xxx.xxx.com'&gt;&gt;/etc/hosts
</code></pre><p>准备所需要的自签名文件(用于tls连接)</p><pre><code>mkdir -p certs &amp;&amp; openssl req   -newkey rsa:4096 -nodes -sha256 -keyout
certs/domain.key   -x509 -days 365 -out certs/domain.crt
Generating a 4096 bit RSA private key
....................................................................................................++
......++
writing new private key to 'certs/domain.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Guangdong
Locality Name (eg, city) []:Guangzhou
Organization Name (eg, company) [Internet Widgits Pty Ltd]:DashCom
Organizational Unit Name (eg, section) []:IT
Common Name (e.g. server FQDN or YOUR name) []:xxx.xxx.xxx.com
Email Address []:xxxxxx@gmail.com
</code></pre><h3 id=启动容器>启动容器</h3><p>首先拷贝出默认的registry容器的配置文件:</p><pre><code>$ sudo mkdir -p /data
$ sudo chmod 777 -R /data
$ sudo docker run -it --rm --entrypoint cat registry:2 \
/etc/docker/registry/config.yml &gt; /data/config.yml
</code></pre><p>修改默认文件，添加<code>proxy</code>字段等，我的配置如下:</p><pre><code>version: 0.1
log:
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: :5000
  tls:
    certificate: /var/lib/registry/domain.crt
    key: /var/lib/registry/domain.key
  headers:
    X-Content-Type-Options: [nosniff]
proxy:
  remoteurl: https://registry-1.docker.io
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3
</code></pre><p>将上一步生成的<code>domain.crt</code>和<code>domain.key</code>文件也拷贝到/data文件夹下.</p><p>现在运行容器:</p><pre><code>$ sudo docker run -d --restart=always -p 5000:5000 --name v2-mirror  -v
/data:/var/lib/registry registry:2 /var/lib/registry/config.yml
</code></pre><p>运行完这条命令后，可以用<code>sudo netstat -anp| grep 5000</code>来检查registry服务是否被启动。</p><h3 id=使用registry服务>使用Registry服务</h3><p>在客户机上，需要做以下设置, 这里我写成脚本的方式，具体的调整需要根据实际情况:</p><pre><code>echo '192.168.0.121    xxx.xxx.xxx.com'&gt;&gt;/etc/hosts
apt-get install -y wget
mkdir -p /etc/docker/certs.d/xxx.xxx.xx.com:5000/
wget -O /etc/docker/certs.d/xxx.xxx.xxx.com:5000/ca.crt http://192.168.0.121/domain.crt
sed -i 's#fd://#fd:// --registry-mirror https://xxx.xxx.xxx.com:5000#' /lib/systemd/system/docker.service
systemctl daemon-reload
systemctl restart docker
</code></pre><p>这里的<code>http://192.168.0.121/domain.crt</code>是我把domain.crt文件放在一个web服务器上了，可以
直接拷贝现成的，改名即可。</p><p>现在测试：</p><pre><code># curl -I https://xxx.xxx.xxx.com:5000/v2 --cacert \ 
/etc/docker/certs.d/xxx.xxx.xxx.com\:5000/ca.crt 

HTTP/1.1 301 Moved Permanently
Docker-Distribution-Api-Version: registry/2.0
Location: /v2/
Date: Fri, 04 Nov 2016 09:42:41 GMT
Content-Type: text/plain; charset=utf-8
</code></pre><p>检查镜像:</p><pre><code># curl  https://xxx.xxx.xxx.com:5000/v2/_catalog --cacert \
/etc/docker/certs.d/xxx.xxx.xxx.com\:5000/ca.crt 
{&quot;&quot;:[&quot;&quot;]}
</code></pre><p>docker pull一个镜像:</p><pre><code># docker pull busybox:latest
</code></pre><p>现在检查:</p><pre><code># curl  https://xxx.xxx.xxx.com:5000/v2/_catalog --cacert \
/etc/docker/certs.d/xxx.xxx.xxx.com\:5000/ca.crt 
{&quot;repositories&quot;:[&quot;library/busybox&quot;,&quot;library/ubuntu&quot;]}
</code></pre><p>可以看到，library/busybox这个镜像已经被缓存在了本地registry仓库中。</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2016/11/03/dockerspeedup/>DockerSpeedUp</a></h1><span class=post-date>Nov 3, 2016<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=docker-registry>Docker Registry</h3><p>因为众所周知的原因，在国内下载Docker镜像会很慢，所以我们更改docker的配置，让它使用
daocloud的加速服务:</p><p>ArchLinux下，编辑以下文件，或者你可以通过<code>sudo systemctl edit docker.service</code>来配置以下
文件:</p><pre><code># vim /etc/systemd/system/docker.service.d/override.conf 
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --registry-mirror=http://1a653205.m.daocloud.io -H fd://
</code></pre><p>现在重新加载服务并重新启动<code>docker.service</code>：</p><pre><code># systemctl daemon-reload
# systemctl restart docker.service
</code></pre><p>从此以后，每一次docker pull都会使用到daocloud提供的加速服务。</p><h3 id=本地私有registry>本地私有registry</h3><p>首先pull下来如下镜像(这两个其实是一个镜像):</p><pre><code># docker pull registry:latest
# docker pull registry:2
</code></pre><p>运行registry实例(注意更改volumn映射):</p><pre><code># docker run -d -p 5000:5000 --restart=always --name registry -v
/root/DockerRegistry:/var/lib/registry registry:2
</code></pre><p>检查实例运行情况:</p><pre><code>➜  ~ sudo docker ps
CONTAINER ID        IMAGE                            COMMAND                  CREATED
STATUS              PORTS                    NAMES
b16b27933709        registry:2                       &quot;/entrypoint.sh /etc/&quot;   7 hours
ago         Up 2 hours          0.0.0.0:5000-&gt;5000/tcp   registry
</code></pre><p>为了让这个服务每次都启动，我们来编写一个systemd服务:</p><pre><code># vim /usr/lib/systemd/system/DockerRegistry.service 
[Unit]
Description=DockerRegistry container
Requires=docker.service
After=docker.service

[Service]
Restart=always
ExecStart=/usr/bin/docker start -a registry
ExecStop=/usr/bin/docker stop -t 2 registry

[Install]
WantedBy=multi-user.target
</code></pre><p>现在使能该服务:</p><pre><code># systemctl enable DockerRegistry.service
Created symlink /etc/systemd/system/multi-user.target.wants/DockerRegistry.service →
/usr/lib/systemd/system/DockerRegistry.service.
</code></pre><h3 id=本地私有registry使用方法>本地私有Registry使用方法</h3><p>将获取到的image tag到私有registry(tag):</p><pre><code># docker tag ubuntu:16.04 localhost:5000/ubuntu:16.04
</code></pre><p>将获取到的image push到私有registry(push):</p><pre><code># docker push localhost:5000/ubuntu:16.04
</code></pre><h3 id=在agent机器上启用本地registry仓库>在agent机器上启用本地registry仓库</h3><p>在systemd类型的机器上，例如Ubuntu16.04上，使用以下命令，添加<code>192.168.177.11:5000</code>这个私有仓库：</p><pre><code># sed -i 's#fd://#fd:// --registry-mirror http://192.168.177.11:5000
--insecure-registry 192.168.177.11:5000#' /lib/systemd/system/docker.service
# systemctl daemon-reload
# systemctl restart docker
</code></pre><p>添加完毕后，检查docker运行参数:</p><pre><code># ps -ef | grep docker
root      4253     1  2 21:48 ?        00:00:00 /usr/bin/dockerd -H fd://
--registry-mirror http://192.168.177.11:5000 --insecure-registry
192.168.177.11:5000
root      4260  4253  0 21:48 ?        00:00:00 docker-containerd -l
unix:///var/run/docker/libcontainerd/docker-containerd.sock --shim
docker-containerd-shim --metrics-interval=0 --start-timeout 2m --state-dir
/var/run/docker/libcontainerd/containerd --runtime docker-runc
</code></pre><p>pull一个已经被放入仓库里的镜像，速度非常快:</p><pre><code># docker pull 192.168.177.11:5000/fedora:latest
latest: Pulling from fedora
41b563eedcb0: Pull complete 
Digest:
sha256:cc4323bf2ee99b414600605e42d1888c4c1b0a08f5793a379c1238af4a44315d
Status: Downloaded newer image for 192.168.177.11:5000/fedora:latest
</code></pre><p>检查安装的镜像:</p><pre><code>$ sudo docker run -it 192.168.177.11:5000/fedora /bin/bash
[root@810f44567c87 /]# cat /etc/redhat-release 
Fedora release 24 (Twenty Four)
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2016/10/24/vrmonitoringviacollectd/>VRMonitoringViaCollectd</a></h1><span class=post-date>Oct 24, 2016<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=environment>Environment</h3><p>The VR&rsquo;s information is listed as following:</p><p><img src=/images/2016_10_24_16_35_58_501x547.jpg alt=/images/2016_10_24_16_35_58_501x547.jpg><br>Now login the VR in CloudStack Agent Node via:</p><pre><code># ssh -i /root/.ssh/id_rsa.cloud -p3922 169.254.0.129
</code></pre><p>Modify its <code>/etc/apt/sources.list</code> like following:</p><pre><code># cat /etc/apt/sources.list
# 

# deb cdrom:[Debian GNU/Linux 7.8.0 _Wheezy_ - Official amd64 NETINST Binary-1
20150110-14:41]/ wheezy main

#deb cdrom:[Debian GNU/Linux 7.8.0 _Wheezy_ - Official amd64 NETINST Binary-1
20150110-14:41]/ wheezy main


deb http://mirrors.aliyun.com/debian wheezy main
deb-src http://mirrors.aliyun.com/debian wheezy main

deb http://mirrors.aliyun.com/ wheezy/updates main
deb-src http://mirrors.aliyun.com/ wheezy/updates main

# wheezy-updates, previously known as 'volatile'
deb http://mirrors.aliyun.com/debian wheezy-updates main
deb-src http://mirrors.aliyun.com/debian wheezy-updates main
deb http://mirrors.aliyun.com/debian/ wheezy-backports main
</code></pre><p>Then <code>apt-get update && apt-get install -y collectd</code>, for installing collectd.</p><h3 id=collectd>Collectd</h3><p>Configuration of collectd:</p><pre><code>$ touch /var/log/collectd.log
$ vim /etc/collectd/collectd.conf
Hostname &quot;WeiLan&quot;
LoadPlugin logfile
#LoadPlugin syslog

&lt;Plugin logfile&gt;
	LogLevel &quot;info&quot;
	File &quot;/var/log/collectd.log&quot;
	Timestamp true
	PrintSeverity false
&lt;/Plugin&gt;

#&lt;Plugin syslog&gt;
#	LogLevel info
#&lt;/Plugin&gt;

..... 

LoadPlugin conntrack
LoadPlugin uptime 
#LoadPlugin df
LoadPlugin write_graphite

&lt;Plugin write_graphite&gt;
	&lt;Carbon&gt;
		Host &quot;192.168.1.79&quot;
		Port &quot;2003&quot;
		Prefix &quot;collectd&quot;
		Postfix &quot;collectd&quot;
		StoreRates false
		AlwaysAppendDS false
		EscapeCharacter &quot;_&quot;
	&lt;/Carbon&gt;
&lt;/Plugin&gt;

</code></pre><p>Start the collectd service via:</p><pre><code># service collectd restart
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2016/10/09/linuxtips6/>LinuxTips6</a></h1><span class=post-date>Oct 9, 2016<br><a class=a_cat href=http://purplepalmdash.github.io/categories/linuxtips>LinuxTips</a></span><h3 id=1--working-tips-for-remove-dulipcate-chars>1. Working tips for remove dulipcate chars</h3><p><a href=http://codereview.stackexchange.com/questions/5441/removing-any-duplicate-characters-in-a-string>http://codereview.stackexchange.com/questions/5441/removing-any-duplicate-characters-in-a-string</a></p><h3 id=2-pip-reinstallation>2. pip reinstallation</h3><p>Uninstall all of the pip installed packages:</p><pre><code># pip freeze | xargs pip uninstall -y
</code></pre><h3 id=3-ipython-notebook>3. ipython notebook</h3><p>Install on ArchLinux via:</p><pre><code>$  sudo pip install &quot;ipython[all]&quot;
</code></pre><p>Be sure to make your internet connection stable.</p><p>Run it via:</p><pre><code>$ ipython notebook
</code></pre><p>ipython2 installation issue:</p><pre><code>$ python2 -m pip install ipykernel
$ python2 -m ipykernel install --user
$ python2 -m pip  install &quot;ipython[all]&quot;
$ ipython3 notebook
</code></pre><p>Now you could create python2&python3 notebooks.</p><h3 id=4-wkhtmltoimage>4. wkhtmltoimage</h3><p>wkhtmltoimage could convert webpage into image files, like following command:</p><pre><code>$ wkhtmltoimage http://purplepalmdash.github.io dash.jpg
</code></pre><h3 id=5-synergyc>5. Synergyc</h3><p>Add following into <code>~/.config/awesome/rc.lua</code>, then you could let synergyc auto-login
into another server:</p><pre><code>&quot;synergyc 192.168.0.219&quot;,
</code></pre><h3 id=6-vromerc>6. vromerc</h3><p>vromerc configuration:</p><pre><code>set userletters=0
</code></pre><h3 id=7-docker-registry>7. Docker Registry</h3><p><a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-14-04>https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-14-04</a></p><h3 id=8-trouble-shooting-in-libvirt>8. Trouble-Shooting In Libvirt</h3><p>After installing archlinux, the virsh list will be failed with following message:</p><pre><code>[root@Arch8G ~]# virsh list
error: failed to connect to the hypervisor
error: Failed to connect socket to '/var/run/libvirt/libvirt-sock': No such file or
directory
</code></pre><p>Solved via:</p><pre><code># systemctl enable libvirtd.service
# systemctl enable virtlogd.service
# systemctl restart libvirtd.service
# systemctl restart virtlogd.service
</code></pre><p>Now <code>virsh list</code> will be OK.</p><p>For user, you should add polkit related items, see:</p><p><a href=https://wiki.archlinux.org/index.php/Libvirt#Using_polkit>https://wiki.archlinux.org/index.php/Libvirt#Using_polkit</a></p><p>also remember add yourself into the group <code>kvm</code>.</p><pre><code>$ sudo usermod -a -G kvm dash
$ sudo usermod -a -G libvirtd dash
</code></pre><h3 id=9-docker-using-daocloud-registry>9. Docker using daocloud registry</h3><p>Edit following file(Or you could edit it via: <code>sudo systemctl edit docker.service</code>):</p><pre><code># vim /etc/systemd/system/docker.service.d/override.conf 
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --registry-mirror=http://1a653205.m.daocloud.io -H fd://
</code></pre><p>Now reload the service and restart docker.service via:</p><pre><code># systemctl daemon-reload
# systemctl restart docker.service
</code></pre><p>Now your docker pulling will from the daocloud website.</p><h3 id=10-deb-local-repository-how-to>10. DEB Local Repository How-TO</h3><p>In a ubuntu system, generate package repository metadatas:</p><pre><code># sudo apt-get install -y dpkg-dev
# dpkg-scanpackages . /dev/null | gzip -9c &gt; Packages.gz
</code></pre><p>Now copy the directory into a webserver, like in <code>192.168.177.11</code>, visit your
webpage, you will see <code>http://192.168.177.11/xxxx</code> contains all of the
packages and their metadata.</p><p>In the systems which you want to use this repository, do following:</p><pre><code>$ sudo vim /etc/apt/sources.list.d/docker.list 
deb http://192.168.177.11/ubuntu1604dockerrepo/	/
$ sudo apt-get update
</code></pre><p>Now examine the package <code>docker-engine</code> which in the private repository:</p><pre><code># apt-cache policy docker-engine
docker-engine:
  Installed: 1.12.3-0~xenial
  Candidate: 1.12.3-0~xenial
  Version table:
 *** 1.12.3-0~xenial 500
        500 http://192.168.177.11/ubuntu1604dockerrepo  Packages
        100 /var/lib/dpkg/status
</code></pre><p>Install this package via:</p><pre><code>$ sudo apt-get install -y docker-engine --allow-unauthenticated
</code></pre><h3 id=11-vagrant-initial-scripts-for-setting-docker>11. vagrant initial scripts for setting docker</h3><p>Create the initial.sh under the vagrant folder:</p><pre><code># Use apt-cacher server
echo 'Acquire::http::Proxy &quot;http://192.168.177.11:3142&quot;;'&gt;/etc/apt/apt.conf.d/01proxy
# Added the primary repository
echo 'deb http://192.168.177.11/ubuntu1604dockerrepo/    /'&gt;/etc/apt/sources.list.d/dockerrepo.list
apt-get update
apt-get -y install vim
apt-get install -y docker-engine --allow-unauthenticated
</code></pre><p>Using local docker registry:</p><pre><code># Use apt-cacher server
echo 'Acquire::http::Proxy
&quot;http://192.168.177.11:3142&quot;;'&gt;/etc/apt/apt.conf.d/01proxy
# Added the primary repository
echo 'deb http://192.168.177.11/ubuntu1604dockerrepo/
/'&gt;/etc/apt/sources.list.d/dockerrepo.list
apt-get update
apt-get -y install vim
apt-get install -y docker-engine --allow-unauthenticated
# Added local docker registry
sed -i 's#fd://#fd:// --registry-mirror http://192.168.177.11:5000
--insecure-registry 192.168.177.11:5000#' /lib/systemd/system/docker.service
systemctl daemon-reload
systemctl restart docker
</code></pre><h3 id=12-nginx-docker-way>12. nginx docker way</h3><p>Run via:</p><pre><code>$ sudo docker run --name docker-nginx -p 80:80 -d -v ~/serve:/usr/share/nginx/html
nginx
</code></pre><p>With auto-index:</p><pre><code>$ sudo docker run --name docker-nginx -p 80:80 -d -v ~/serve:/usr/share/nginx/html jrelva/nginx-autoindex
</code></pre><h3 id=13-combine-pictures>13. Combine Pictures</h3><p>fotowall could genrate photo wall:</p><pre><code>$ yaourt -S fotowall
</code></pre><p>Hugin could generate full-view pictures.</p><pre><code>$ sudo pacman -S hugin
</code></pre><h3 id=14-docker-swarm-how-to>14. Docker Swarm How-to</h3><p><a href=http://www.lxy520.net/2016/07/02/shi-yong-docker-1-12-da-jian-duo-zhu-ji-docker-swarmji-qun/>http://www.lxy520.net/2016/07/02/shi-yong-docker-1-12-da-jian-duo-zhu-ji-docker-swarmji-qun/</a></p><p><a href=https://www.linux.com/learn/how-use-docker-machine-create-swarm-cluster>https://www.linux.com/learn/how-use-docker-machine-create-swarm-cluster</a></p><h3 id=15-linux-性能监控专题>15. Linux 性能监控专题</h3><p><a href=https://linux.cn/topic-linux-system-performance-monitoring.html>https://linux.cn/topic-linux-system-performance-monitoring.html</a></p><h3 id=16-docker-compose-in-swarm>16. docker-compose in swarm</h3><p>Install experimental version via:</p><pre><code>## 测试版
curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/test/internet | sh
curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/test/intranet | sh

## 实验版
curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/experimental/internet | sh
curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/experimental/intranet | sh
</code></pre><p><a href=https://docs.docker.com/compose/swarm/>https://docs.docker.com/compose/swarm/</a></p><h3 id=17-kubernetes>17. kubernetes</h3><p><a href=https://coreos.com/kubernetes/docs/latest/kubernetes-on-vagrant.html>https://coreos.com/kubernetes/docs/latest/kubernetes-on-vagrant.html</a><br><a href=http://andrewmichaelsmith.com/2016/05/my-kubernetes-setup/>http://andrewmichaelsmith.com/2016/05/my-kubernetes-setup/</a><br><a href=http://www.codeceo.com/article/kubernetes-guide.html>http://www.codeceo.com/article/kubernetes-guide.html</a></p><h3 id=18-changing-disks>18. Changing disks</h3><p>After changing disk(switch them) in archlinux, the efi menu should be
rewritten into:</p><pre><code>$ sudo cat /boot/loader/entries/arch.conf 
title	ArchLinux
linux	/vmlinuz-linux
initrd	/initramfs-linux.img
options	root=/dev/sdb2 rw
</code></pre><p>Becareful of <code>root=/dev/sda2</code> changing to <code>root=/dev/sdb2</code>.</p><h3 id=17-vagrant-ip-setting>17. Vagrant IP Setting</h3><p>If your vagrant&rsquo;s ip address won&rsquo;t set properly, for example, eth1&rsquo;s
configuration is added into eth0, then you should install the following
package:</p><pre><code>$ sudo pacman -S community/virtualbox-guest-utils
</code></pre><h3 id=18-badblocks-checking-in-archlinux>18. badblocks checking in ArchLinux</h3><p>Check the sda5 and sda3 of the disk via:</p><pre><code>$ sudo badblocks -v /dev/sda5&gt;badsectors5.txt &amp;&amp; sudo badblocks -v
/dev/sda3&gt;badsectors3.txt
</code></pre><p>smartmontools for checking disk healthy:</p><pre><code>$ sudo pacman -S smartmontools
$ sudo smartctl -s on /dev/sda
$ sudo smartctl -H /dev/sda1
$ sudo smartctl -H /dev/sda
</code></pre><h3 id=19-manually-build-wordpress>19. Manually build wordpress</h3><p><a href=https://www.sitepoint.com/how-to-manually-build-docker-containers-for-wordpress/>https://www.sitepoint.com/how-to-manually-build-docker-containers-for-wordpress/</a></p><h3 id=20-xenserver-get-rrd-data>20. XenServer Get rrd data</h3><p>Write a py file on XenServer, and run it:</p><pre><code>import pprint, time, sys, os
import XenAPI
session = XenAPI.xapi_local()
session.xenapi.login_with_password(&quot;root&quot;, &quot;xxxxx&quot;)
session_id=session._session
print session_id
wget_rrd_url=&quot;wget http://%s/host_rrd\?session_id\=%s&quot; %(&quot;192.168.10.187&quot;, session._session)
print wget_rrd_url
os.system(wget_rrd_url)
session.logout()
</code></pre><h3 id=21-xen-in-ubuntu>21. Xen In Ubuntu</h3><p>In ubuntu16.04, use xen hypervisor:</p><pre><code>$ sudo apt-get update &amp;&amp; sudo apt-get upgrade -y &amp;&amp; sudo apt-get dist-upgrade -y
$ sudo apt-get install -y xen-hypervisor-amd64
$ sudo apt-get install -y virtinst virt-manager
</code></pre><p>Edit the grub for enabling the xen hypervisor:</p><pre><code>$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT=&quot;Xen 4.1-amd64&quot;
GRUB_CMDLINE_XEN=&quot;dom0_mem=1024M,max:1024M dom0_max_vcpus=2&quot;
$ sudo update-grub
$ sudo reboot
</code></pre><p>Examine the usage:</p><pre><code>$ sudo xl list
Name                                        ID   Mem VCPUs	State	Time(s)
Domain-0                                     0  1024     2     r-----      28.7
</code></pre><h3 id=22-pv-or-hvm>22. pv or hvm</h3><p>Decided via:</p><pre><code>$ sudo xl list --long CentOS69
</code></pre><p>Examine the result of the output:</p><p><img src=/images/2016_11_23_15_39_44_682x316.jpg alt=/images/2016_11_23_15_39_44_682x316.jpg></p><p>in our example, this machine is hvm, not pv.</p><h3 id=23-vboxsf>23. vboxsf</h3><p>Problem:</p><pre><code>sudo mount -t vboxsf Shared_Folder ~/SF/
</code></pre><p>Gave following result:</p><pre><code>VirtualBox: mount.vboxsf: mounting failed with the error: No such device
</code></pre><p>The solution for me was to stop vboxadd and do a setup after that:</p><pre><code>cd /opt/VBoxGuestAdditions-*/init  
sudo ./vboxadd setup
</code></pre><p>Then, you could also modprobe following:</p><pre><code>$ sudo modprobe -a vboxguest vboxsf
$ sudo mount -t vboxsf -o uid=1000,gid=1000 vagrant /vagrant
</code></pre><p>Case you build failed, try following:</p><pre><code>$ sudo yum install kernel-devel gcc
$ echo export KERN_DIR=/usr/src/kernels/`uname -r` &gt;&gt; ~/.bashrc
$ source ~/.bashrc     # to set the variable in your current shell
$ sudo echo $KERN_DIR  # verify the value is set
$ sudo ls $KERN_DIR    # verify the directory exists 
</code></pre><h3 id=24-purge-xen>24. purge xen</h3><p>For switching back to default linux kernel rather than xen hypervisor, do
following:</p><pre><code>$ sudo apt-get purge xen*
$ sudo vim /etc/default/grub
// remove all of the xen related
$ sudo reboot
</code></pre><h3 id=25-lvextend>25. lvextend</h3><p>extend to all of the usable space:</p><pre><code>$ sudo lvextend -l +100%FREE /dev/vgonsda/lvubuntu
$ sudo resize2fs /dev/vgonsda/lvubuntu 
</code></pre><p>In my situation this extend the root partition from 50G to 250G(all of the
disk size)</p><h3 id=26-archlinux-screen-brightness>26. ArchLinux Screen Brightness</h3><p>Examine the brightness in sys folder:</p><pre><code># ls /sys/class/backlight 
acpi_video0  intel_backlight
</code></pre><p>In our case is <code>intel_backlight</code>, thus we go into this folder and view its
parameters:</p><pre><code># ls /sys/class/backlight/intel_backlight 
actual_brightness  bl_power  brightness  device  max_brightness  power
subsystem  type  uevent
# cat /sys/class/backlight/intel_backlight/max_brightness
648
# cat /sys/class/backlight/intel_backlight/brightness    
643
</code></pre><p>It&rsquo;s too bright, so we low down its value via:</p><pre><code># tee /sys/class/backlight/intel_backlight/brightness &lt;&lt;&lt; 400
400
</code></pre><p>or we could set it via <code>xbacklight</code>:</p><pre><code># xbacklight -set 50
# xbacklight -set 100 ### Set to 100% brightness.
</code></pre><h3 id=27-one-click-startup>27. One-click startup</h3><p><a href=https://item.jd.com/10398791583.html>https://item.jd.com/10398791583.html</a></p><h3 id=28-cloudstack-ha>28. CloudStack HA</h3><p><a href=http://severalnines.com/blog/how-deploy-high-availability-cloudstackcloudplatform-mariadb-galera-cluster>http://severalnines.com/blog/how-deploy-high-availability-cloudstackcloudplatform-mariadb-galera-cluster</a></p><h3 id=29-get-total-memory-of-xenserver>29. Get total memory of XenServer</h3><p>Command:</p><pre><code>$  xl info | grep total_memory
total_memory           : 7805
</code></pre><h3 id=30-apt-fast>30. apt-fast</h3><p>Install apt-fast for fetching back packages:</p><pre><code>sudo add-apt-repository ppa:saiarcot895/myppa
sudo apt-get update
sudo apt-get -y install apt-fast
</code></pre><h3 id=31-qemu-bridge-issue>31. qemu bridge issue</h3><p>Error message:</p><pre><code>$ virsh start xcenter-win7
error: Failed to start domain xcenter-win7
error: internal error: /usr/lib/qemu/qemu-bridge-helper --use-vnet --br=br0
--fd=25: failed to communicate with bridge helper: Transport endpoint is not
connected
stderr=failed to parse default acl file `/etc/qemu/bridge.conf'
</code></pre><p>Solved via:</p><pre><code>$ sudo mkdir -p /etc/qemu
$ sudo echo &quot;allow br0&quot;&gt;/etc/qemu/bridge.conf
</code></pre><p>Then you could use the qemu.</p><h3 id=32-purge-packages-in-archlinux>32. purge packages in archlinux</h3><p>The command is:</p><pre><code>$ sudo pacman -Rsn vagrant
</code></pre><p>This will remove all of the vagrant and its related packages.</p><h3 id=33-dd-for-rescue-disk>33. dd for rescue disk</h3><p>command:</p><pre><code>$ sudo dd bs=262144 if=/dev/hda /dev/hdb conv=noerror,sync bs=10M  status=progress
</code></pre><h3 id=34-download-images-automatically>34. Download images automatically</h3><p>Do following:</p><pre><code>until sudo docker pull mesoscloud/zookeeper:3.4.6-ubuntu-14.04
do
	echo &quot;fucku&quot;
done

until sudo docker pull mesoscloud/mesos-master:0.24.1-ubuntu-14.04
do
	echo &quot;fucku1&quot;
done

until sudo docker pull mesoscloud/mesos-slave:0.24.1-ubuntu-14.04
do
	echo &quot;fucku2&quot;
done
until sudo docker pull mesosphere/marathon:v0.15.0
do
	echo &quot;fuck U&quot;
done
sudo docker save mesosphere/marathon:v0.15.0 | bzip2&gt;marathon.tar.bz2
sudo docker save mesoscloud/mesos-slave:0.24.1-ubuntu-14.04| bzip2&gt;slave.tar.bz2
sudo docker pull mesoscloud/zookeeper:3.4.6-ubuntu-14.04|bzip2&gt;zookeeper.tar.bz2
sudo docker pull mesoscloud/mesos-master:0.24.1-ubuntu-14.04|bzip2&gt;master.tar.bz2
</code></pre><h3 id=35-monitoring-docker>35. Monitoring Docker</h3><p>For monitoring docker host, containers, monitoring systems, and form the alert
system.</p><p><a href=https://stefanprodan.com/2016/a-monitoring-solution-for-docker-hosts-containers-and-containerized-services/>https://stefanprodan.com/2016/a-monitoring-solution-for-docker-hosts-containers-and-containerized-services/</a></p><h3 id=36-stop-docker-compose>36. Stop Docker-compose</h3><p>Via <code>sudo docker-compose down</code>, then you will get all of the docker-compose
uped container down.</p><h3 id=37-tsocks>37. tsocks</h3><p>Install:</p><pre><code>$ sudo apt-get install tsocks
</code></pre><p>Configure:</p><pre><code>$ sudo vim /etc/tsocks.conf
local = 192.168.1.0/255.255.255.0
#local表示本地的网络，也就是不使用socks代理的网络  
local = 127.0.0.0/255.0.0.0  
server = 127.0.0.1   #socks服务器的IP  
server_type = 5  #socks服务版本  
server_port = 8888  ＃socks服务使用的端口 
</code></pre><h3 id=38-vimdiff>38. vimdiff</h3><p>Use dp or do for copying left to right or copy right to left.</p><h3 id=39-docker-to-rocket>39. Docker to Rocket</h3><p>Tranform images via:</p><p><a href=https://github.com/appc/docker2aci>https://github.com/appc/docker2aci</a></p><pre><code>$ docker save -o ubuntu.docker ubuntu
$ docker2aci ubuntu.docker
Extracting 706766fe1019
Extracting a62a42e77c9c
Extracting 2c014f14d3d9
Extracting b7cf8f0d9e82

Generated ACI(s):
ubuntu-latest.aci
$ actool --debug validate ubuntu-latest.aci
ubuntu-latest.aci: valid app container image
</code></pre><h3 id=40-detect-display>40. Detect display</h3><p>Install lshw via:</p><pre><code>$ sudo pacman -S lshw
$ sudo lshw -C display
$ sudo lshw -C display
</code></pre><h3 id=41-change-nomachine-resolution>41. Change Nomachine resolution</h3><p>Detect all of the resolution configuration:</p><pre><code># xrandr -q
</code></pre><p>Now you get all of the resolution configuraitons. Change the current fb via:</p><pre><code>$ xrandr --fb 1920x1080
</code></pre><h3 id=42-grafana-collectd-template>42. Grafana collectd template</h3><p><a href=https://grafana.net/dashboards/203>https://grafana.net/dashboards/203</a><br>Then manually replace all of the datasource segment:<br>For example: <code>"datasource": "79's Graphite",</code>.</p><h3 id=43-at-command>43. at command</h3><p>For do tasks in specified time:</p><pre><code># at 10PM
warning: commands will be executed using /bin/sh
at&gt; cd /home/juju/http; axel 
http://mirrors.aliyun.com/centos/7.3.1611/isos/x86_64/CentOS-7-x86_64-Everything-1611.iso
at&gt; &lt;EOT&gt;
job 2 at Tue Dec 20 22:00:00 2016
</code></pre><p>Then this at will automatically download the centos7.3 iso in 10:00PM.</p><h3 id=44-run-squid-in-docker>44. Run squid in docker</h3><p><a href=https://hub.docker.com/r/sameersbn/squid/>https://hub.docker.com/r/sameersbn/squid/</a></p><h3 id=45-rkt-image-fetch>45. rkt image fetch</h3><p>Command:</p><pre><code>$ rkt fetch --insecure-options=image coreos-hyperkube-v1.4.6_coreos.0.aci
image: using image from file coreos-hyperkube-v1.4.6_coreos.0.aci
sha512-114e15d31926a6b185f658bc5c522fee
core@coreos1 ~ $ rkt image list
ID			NAME						SIZE
IMPORT TIME	LAST USED
sha512-114e15d31926	quay.io/coreos/hyperkube:v1.4.6_coreos.0	637MiB
1 minute ago	1 minute ago
</code></pre><h3 id=46-linux-installation-date>46. Linux Installation Date</h3><p>Via:</p><pre><code>ls -alct /root
</code></pre><h3 id=47-daocloud-speedup-in-ubuntu1404>47. Daocloud speedup in ubuntu14.04</h3><p>Edit following file:</p><pre><code>$ sudo vim /etc/default/docker
DOCKER_OPTS=&quot;$DOCKER_OPTS --registry-mirror=http://1a653205.m.daocloud.io&quot;
$ sudo service docker restart
</code></pre><h3 id=48-hugo-error>48. hugo error</h3><p>When meeting following issue:</p><pre><code>hugo     
Started building sites ...
ERROR: 2017/01/03 12:02:00 general.go:241: .Page's RSSlink is deprecated and
will be removed in Hugo 0.2. Use RSSLink instead
</code></pre><p>Solution will be:</p><pre><code>$ grep -i &quot;rsslink&quot; ./ -r
./themes/hyde-a/layouts/partials/sidebar.html:      {{ if .Site.Params.rss
}}&lt;a href=&quot;{{ .RSSlink }}&quot; type=&quot;application/rss+xml&quot;&gt;&lt;i class=&quot;fa
fa-rss-square fa-3x&quot;&gt;&lt;/i&gt;&lt;/a&gt;{{ end }}
</code></pre><p>Replace all of the <code>RSSlink</code> with <code>RSSLinke</code>.</p><h3 id=49-start-virtualbox-vms>49. Start VirtualBox Vms</h3><p>Start k8s cluster via one command:</p><pre><code>$ VBoxManage list vms
$ VBoxManage startvm &quot;k8s_coreos1&quot; --type headless
$ VBoxManage startvm &quot;k8s_coreos2&quot; --type headless
$ VBoxManage startvm &quot;k8s_coreos3&quot; --type headless
</code></pre><h3 id=50-ip-namespace>50. ip namespace</h3><p>Some operation tips:</p><pre><code># ip netns add testns
# ip netns exec testns ip addr
# ip netns exec testns ifconfig -a
# ip netns exec testns bash
# ip netns list
# ip netns delete testns
# ip netns list
# pacman -S ethtool
# ethtool -k br0 | grep netns
</code></pre><h3 id=51-ip-links>51. ip links</h3><p>Create a Veth pair:</p><pre><code># ip link add veth0 type veth peer name veth1
</code></pre><p>Examine the result:</p><pre><code># ip link show
24: veth1@veth0: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN
mode DEFAULT group default qlen 1000
    link/ether 02:ec:bd:78:59:06 brd ff:ff:ff:ff:ff:ff
25: veth0@veth1: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN
mode DEFAULT group default qlen 1000
    link/ether 5a:a6:f5:88:27:9f brd ff:ff:ff:ff:ff:ff
</code></pre><p>Could it be transfered?</p><pre><code>[root@DashSSD ~]# ethtool -k veth0 | grep netns
netns-local: off [fixed]
[root@DashSSD ~]# ethtool -k veth1 | grep netns
netns-local: off [fixed]
</code></pre><p>We could view Veth as a 2-wired, so we first add one port to a namespace:</p><pre><code># ip netns add netns1
# ip link set veth1 netns netns1
# ip link show
</code></pre><p>via <code>ip link show</code> we found the veth1 vanished.</p><p>And we could view the namespace owned link equips via:</p><pre><code># ip netns exec netns1 ip link show
1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT group default
qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
24: veth1@if25: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode
DEFAULT group default qlen 1000
    link/ether 02:ec:bd:78:59:06 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</code></pre><p>Add veth1 ip address:</p><pre><code># ip netns exec netns1 ip addr add  10.1.1.1/24 dev veth1
</code></pre><p>Add veth0 ip address:</p><pre><code># ip addr add 10.1.1.2/24 dev veth0
</code></pre><p>Now startup the equipment:</p><pre><code># ip netns exec netns1 ip link set dev veth1 up
# ip link set dev veth0 up
</code></pre><p>Ping eath other:</p><pre><code># ping 10.1.1.1
# ip netns exec netns1 ping 10.1.1.2
</code></pre><p>View remote:</p><pre><code>[root@DashSSD dash]# ip netns exec netns1 ethtool -S veth1
NIC statistics:
     peer_ifindex: 25
[root@DashSSD dash]# ip link | grep 25
25: veth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state
UP mode DEFAULT group default qlen 1000
</code></pre><h3 id=52-reset-virtualbox>52. Reset Virtualbox</h3><p>Via following command:</p><pre><code>$ VBoxManage controlvm &quot;k8s_coreos1&quot; reset
</code></pre><h3 id=53-docker-monitoring>53. Docker monitoring</h3><p>Use <code>docker stats</code> for viewing the resource usage of the docker instance.</p><pre><code>$ sudo docker ps | grep squid
049axxxxx
$ sudo docker status 049axxxxx
</code></pre><p>The displaying status is:</p><p><img src=/images/2017_01_09_09_43_40_747x148.jpg alt=/images/2017_01_09_09_43_40_747x148.jpg></p><p>Use <code>docker top 049axxxx</code> could see the resource usage.</p><p><code>docker port</code> for viewing the port usage.</p><h3 id=54-sdiff>54. sdiff</h3><p>You could use sdiff for generating side-to-side diff files.</p><h3 id=55-installation-of-xenserver-65>55. Installation of XenServer 6.5</h3><p>Use rufus for writing XenServer 6.5 iso into the flash disk, then install
system.</p><p><a href="https://rufus.akeo.ie/?locale=zh_CN">https://rufus.akeo.ie/?locale=zh_CN</a></p><h3 id=56-normal-user-using-virtualbox-usb>56. Normal User Using Virtualbox USB</h3><p>Add the user into the group of <code>vboxuser</code>, then he have the priviledge of
using usb device.</p><pre><code>$ sudo usermod -a -G vboxusers xxxx
</code></pre><p>Notice: you have to restart the machine to let your configuration take
effects.</p><h3 id=57-shutdown-all-of-the-running-vms>57. Shutdown all of the running VMs</h3><p>Via following commands:</p><pre><code>$ vboxmanage list runningvms | sed -r 's/.*\{(.*)\}/\1/' | xargs -L1 -I {} VBoxManage controlvm {}  poweroff
</code></pre><h3 id=58-capture-screenshot>58. Capture ScreenShot</h3><p>Use following command <code>hucapscr</code> for capturing the screenshot and save
the link related markdown tips:</p><pre><code>$ sudo vim /usr/bin/hucapscr 
scrot -s '%Y_%m_%d_%H_%M_%S_$wx$h.jpg' -e 'mv $f ~/capscr/'
filename=`ls -t ~/capscr | head -n1`
cp ~/capscr/$filename /home/dash/Code/purplepalmdash.github.io/static/images/
#echo &quot;![/images/&quot;$filename&quot;](/images/&quot;$filename&quot;)&quot;
echo &quot;![/images/&quot;$filename&quot;](/images/&quot;$filename&quot;)&quot;|xclip
</code></pre><p>Simply ruun <code>hucapscr</code>, it will auto save the pictures.</p><h3 id=59-force-umount>59. Force Umount</h3><p>For example, you could force umount the nfs directory when nfs server is gone.</p><pre><code>umount -f -l /mnt/myfolder, and that will fix the problem.

-f – Force unmount (in case of an unreachable NFS system). (Requires kernel 2.1.116 or later.)
-l – Lazy unmount. Detach the filesystem from the filesystem hierarchy now, and cleanup all references to the filesystem as soon as it is not busy anymore. (Requires kernel 2.4.11 or later.)
</code></pre><h3 id=69-disk-clone>69. Disk Clone</h3><p>For recovering the error disks:</p><pre><code>$ sudo dd if=/dev/sdX of=/dev/sdY bs=64K conv=noerror,sync
</code></pre><h3 id=70-xenserver-time-sync-issue>70. XenServer Time Sync Issue</h3><p>tsc mode enable:</p><pre><code># xe vm-list
# xe vm-param-set uuid=82aa4fec-6b95-4f39-050c-cfbd3a8b9065 platform:tsc_mode=2
</code></pre><p>Or you could enable the ntp to the host IP.</p><p>Or if not HVM, check:</p><pre><code># echo 1 &gt; /proc/sys/xen/independent_wallclock
</code></pre><h3 id=71-route-for-internet>71. Route for Internet</h3><p>First make sure the <code>ip_forward</code> is enabled in <code>/proc</code>, then enter following
commands for setting up the NAT.</p><pre><code>$ sudo iptables -t nat -A POSTROUTING -s  192.168.0.220/24 -j SNAT --to 192.168.0.121
$ sudo iptables -A FORWARD -s 192.168.0.220 -j ACCEPT
</code></pre><p>Next you should set the routing to the right IP address.</p><h3 id=72-time-sync-using-systemd>72. Time Sync using systemd</h3><p>Via following:</p><pre><code># timedatectl set-ntp true 
# timedatectl status
# vim /etc/systemd/timesyncd.conf
[Time]
NTP=0.arch.pool.ntp.org 1.arch.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org
FallbackNTP=0.pool.ntp.org 1.pool.ntp.org 0.fr.pool.ntp.org
</code></pre><h3 id=73-opensuse-sshd>73. OpenSuse sshd</h3><p>Disable the firewalld via yast, and enable the sshd port from external zone.</p><h3 id=74-vagrant-libvirt-in-archlinux>74. vagrant-libvirt In Archlinux</h3><p>Using following script you could re-enable vagrant-libvirt in archlinux for
vagrant newer than 1.9.1.</p><pre><code>#!/bin/sh

# in case it's already installled
vagrant plugin uninstall vagrant-libvirt

# vagrant's copy of curl prevents the proper installation of ruby-libvirt
sudo mv /opt/vagrant/embedded/lib/libcurl.so{,.backup}
sudo mv /opt/vagrant/embedded/lib/libcurl.so.4{,.backup}
sudo mv /opt/vagrant/embedded/lib/libcurl.so.4.4.0{,.backup}
sudo mv /opt/vagrant/embedded/lib/pkgconfig/libcurl.pc{,.backup}

CONFIGURE_ARGS=&quot;with-libvirt-include=/usr/include/libvirt with-libvirt-lib=/usr/lib&quot; vagrant plugin install vagrant-libvirt

# https://github.com/pradels/vagrant-libvirt/issues/541
export PATH=/opt/vagrant/embedded/bin:$PATH
export GEM_HOME=~/.vagrant.d/gems/2.2.5
export GEM_PATH=$GEM_HOME:/opt/vagrant/embedded/gems

gem uninstall ruby-libvirt
gem install ruby-libvirt

# put vagrant's copy of curl back
sudo mv /opt/vagrant/embedded/lib/libcurl.so{.backup,}
sudo mv /opt/vagrant/embedded/lib/libcurl.so.4{.backup,}
sudo mv /opt/vagrant/embedded/lib/libcurl.so.4.4.0{.backup,}
sudo mv /opt/vagrant/embedded/lib/pkgconfig/libcurl.pc{.backup,}
</code></pre><p>The reason is: you have to change the Gem path from <code>/opt</code> to <code>/usr/lib</code>.</p><h3 id=75-wget-jrejdk>75. wget jre/jdk</h3><p>Via vollowing command you could using wget for download jre/jdk from oracle:</p><pre><code># wget -c --no-check-certificate --no-cookies --header &quot;Cookie: oraclelicense=accept-securebackup-cookie&quot; http://download.oracle.com/otn-pub/java/jdk/6u45-b06/jdk-6u45-linux-x64.bin
# wget -c --no-check-certificate --no-cookies --header &quot;Cookie: oraclelicense=accept-securebackup-cookie&quot; http://download.oracle.com/otn-pub/java/jdk/6u45-b06/jre-6u45-linux-x64.bin
</code></pre><h3 id=76-local-cdn>76. Local CDN</h3><p><a href=http://www.appinn.com/local-cdn/>http://www.appinn.com/local-cdn/</a></p><h3 id=77-gateway-on-multiple-nics>77. Gateway On Multiple NICs</h3><p>Add following lines in <code>/etc/rc.local</code> in Ubuntu:</p><pre><code>eval `route -n | awk '{ if ($8 ==&quot;eth0&quot; &amp;&amp; $2 != &quot;0.0.0.0&quot;) print &quot;route del default gw &quot; $2; }'`
route add default gw 192.168.0.176
</code></pre><h3 id=78-virt-inst>78. virt-inst</h3><p>For installing systems:</p><pre><code># virt-install --name=test --ram 512 --vcpus=1 -f /home/kvm/test.qcow2 --cdrom /opt/CentOS-6.5-x86_64-bin-DVD1.iso --graphics vnc,listen=0.0.0.0,port=5988, --network network=default, --force --autostart
</code></pre><p>Then vncviewer localhost:5988 you could get the installation window.</p><h3 id=79-atom-plugin-install>79. Atom plugin install</h3><p>Install it via <code>proxychains4 apm install markdown-pdf</code></p><h3 id=80-simple-web-server>80. Simple Web Server</h3><pre><code>$ wget https://gist.githubusercontent.com/sumpygump/9908417/raw/5fa991fda103d0b7a0c38512394a83ccada9ad6c/nweb23.c
$ gcc -O -DLINUX nweb32.c -o nweb
$ ./nweb 8848 ./
</code></pre><h3 id=81-show-git-config-infos>81. Show git config infos</h3><p>Show configurations of git global setting:</p><pre><code>$ git config --list
user.email=xxxx@gmail.com
user.name=xxxx
</code></pre><p>Set the git global setting:</p><pre><code># git config --global user.email xxxxx@gmail.com
# git config --global user.name &quot;xxxx&quot;
</code></pre><h3 id=82-wordpress-issue>82. Wordpress issue</h3><p>When using dockerized wordpress, you got the same content after you run <code>sudo docker-compose down</code>, the reason is because the docker-compose use the same
volumes, if you runs:</p><pre><code>$ sudo docker volume prune
</code></pre><p>Your temp unused volumes will be deleted. Then you got a brand new wordpress
docker container.</p><h3 id=83-python-extract-zip>83. python extract zip</h3><p>For converting Chinese:</p><pre><code>#!/usr/bin/env python
# -*- coding: utf-8 -*-
# uzip.py

import os
import sys
import zipfile

print &quot;Processing File &quot; + sys.argv[1]

file=zipfile.ZipFile(sys.argv[1],&quot;r&quot;);
for name in file.namelist():
    utf8name=name.decode('gbk')
    print &quot;Extracting &quot; + utf8name
    pathname = os.path.dirname(utf8name)
    if not os.path.exists(pathname) and pathname!= &quot;&quot;:
        os.makedirs(pathname)
    data = file.read(name)
    if not os.path.exists(utf8name):
        fo = open(utf8name, &quot;w&quot;)
        fo.write(data)
        fo.close
file.close()
</code></pre><p>Then extract the files via:</p><pre><code>$ python2 abc.py aaa.zip
</code></pre><h3 id=84-docker-compose-network>84. docker-compose network</h3><p>Examine the network via <code>docker network ls</code></p><h3 id=85-teamviewer-for-rpi>85. teamviewer for rpi</h3><p>Install will ask for installing qt, just run <code>apt-get install -f</code> solves the problem.</p><h3 id=86-remote-controlling-for-rpi>86. Remote controlling for rpi</h3><p>Using dataplicity</p></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/105/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/105/>105</a></li><li class="page-item active"><a class=page-link href=/page/106/>106</a></li><li class=page-item><a class=page-link href=/page/107/>107</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/237/>237</a></li><li class=page-item><a href=/page/107/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/237/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>