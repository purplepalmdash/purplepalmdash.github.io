<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/04/28/trouble-shooting-on-jujus-local-deployment/>Trouble Shooting On Juju's Local Deployment</a></h1><span class=post-date>Apr 28, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>When deploying juju, after <code>juju bootstrap</code>, use juju ssh for login, it will hint me:</p><pre><code>$ juju ssh 1
......
Permission denied (publickey).

</code></pre><p>That could be solved by specify the id_rsa.pub key:</p><pre><code>$ ssh-keygen -t rsa -b 2048
$ juju bootstrap
$ juju bootstrap
$ juju deploy wordpress
$ juju deploy mysql
$ juju add-relation wordpress mysql
$ juju status
$ juju expose wordpress

</code></pre><p>By doing this you could make your juju deployment on local successfully.</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/04/28/use-reave-for-testing-wireless-security/>Use reave for testing wireless security</a></h1><span class=post-date>Apr 28, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>For those who want to test the wireless security(Wireless Router), following is a serial of tools for automatically scan the WIFI and try to find the entrance to inner network.</p><h3 id=preparation>Preparation</h3><p>Install following packages:</p><pre><code>$ sudo apt-get install macchanger  aircrack-ng reaver

</code></pre><h3 id=testing>Testing</h3><p>Suppose the wireless port in our equipment is mlan0, following are the detailed steps:</p><pre><code># macchanger -m 00:11:22:33:44:55 mlan0
# airmon-ng start mlan0
# ifconfig mlan0mon down
# macchanger -m 00:11:22:33:44:55 mlan0mon
# ifconfig mlan0mon up
# airodump-ng mlan0mon
# reaver -i mlan0mon -b xx:xx:xx:xx:xx -vv -dh-small

</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/04/27/shi-yong-fuelbu-shu-opencontrail-2/>使用Fuel部署OpenContrail(2)</a></h1><span class=post-date>Apr 27, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>本节在前面部署完Fuel 控制节点的基础上，接着部署一个OpenStack HA环境，并准备好OpenContrail的三个部署节点。</p><h3 id=节点初始化准备>节点初始化准备</h3><p>所有加入到Fuel控制节点里的机器，在加入前都需要进行初始化配置，而后才可以被Fuel所识别.<br>在所有配置好的机器里，点击Details-> Boot Options, 设置如下：<br><img src=/images/2015_04_27_17_14_26_532x372.jpg alt=/images/2015_04_27_17_14_26_532x372.jpg><br>因为第一次启动的时候，磁盘里是没有内容的，机器会自动从第二选项启动(PXE). 机器将自动侦测5个网段上的PXE Server， 因为Fuel Controller接管了10.20.0.0/24 网段上的PXE请求，它将会把机器从PXE变成可部署的状态。</p><h3 id=openstack-ha环境创建>OpenStack HA环境创建</h3><p>创建一个OpenStack HA环境，如下步骤，因为是HA，所以需要至少三个OpenStack Controller节点和一个OpenStack Compute节点。<br>点击界面里的New OpenStack Environment, 在弹出的窗口中，命名需要部署的HA环境名，并选择部署所需要的镜像，这里我们选择Ubuntu作为部署OpenStack的基础镜像。<br><img src=/images/2015_04_27_17_18_22_680x435.jpg alt=/images/2015_04_27_17_18_22_680x435.jpg><br>点击下一步，选择HA模式：<br><img src=/images/2015_04_27_17_20_13_681x427.jpg alt=/images/2015_04_27_17_20_13_681x427.jpg><br>点击下一步，选择计算节点模式，这里选择qemu或者kvm问题都不大，不要选vcenter就是了:<br><img src=/images/2015_04_27_17_21_48_683x435.jpg alt=/images/2015_04_27_17_21_48_683x435.jpg><br>点击下一步，进入到网络模式选择，选择Legacy Network(nova-network), 先部署成这种形式，接下来我们会使用neutron和contrail的组合重新规划网络:<br><img src=/images/2015_04_27_17_23_03_682x428.jpg alt=/images/2015_04_27_17_23_03_682x428.jpg><br>点击下一步，Storage Backend，因为我们不打算引入任何存储节点，这里选择Default，直接进入下一步， Additional Service里我们也不打算启任何额外的服务，一路Next直到最后Create出整个OpenStack环境。</p><p>依次创建另一个OpenStack HA环境，用来部署三台Contrail Controller的节点机.</p><h3 id=openstack环境网络>OpenStack环境网络</h3><p>Fuel默认的网络配置会激活三个物理端口，第一个端口接入PXE网络，第二个接入Public网络，第三个上启三个VLAN，分别接入到Management/Storage/Private网络。我认为VLAN的配置增加了配置和部署的复杂度，更改为五个物理网络，分别使用我们在Virt-Manager中创建出的五个物理网卡接入。更改方法如下:<br>点击Network, 更改Management下的CIDR，手动填入10.55.55.0/24，然后去掉前面的Use VLAN Tag:<br><img src=/images/2015_04_27_17_32_09_465x466.jpg alt=/images/2015_04_27_17_32_09_465x466.jpg></p><p>依次修改Storage网络和Private网络，更改完毕后，你的配置应该看起来是这样的:<br><img src=/images/2015_04_27_17_34_33_387x388.jpg alt=/images/2015_04_27_17_34_33_387x388.jpg></p><p>对于Public网络我们不需要有任何修改，保持172.16网段的配置即可。</p><p>确认Network的配置为FlatDHCP Manager:<br><img src=/images/2015_04_27_17_35_37_391x149.jpg alt=/images/2015_04_27_17_35_37_391x149.jpg></p><h3 id=建立openstack-ha环境>建立OpenStack HA环境</h3><p>经PXE启动的虚拟机会把自己加入到"Unallocated Nodes"的队列里，在创建好的环境里，点击Node后，可以看到Fuel对角色的分配，添加一个OpenStack Controller的步骤如下：<br>在Assign Roles里选择"Controller&rdquo;, 下面的备选节点里选择一台机器后，Apply Changes按钮会变绿，点击进入下一步.<br><img src=/images/2015_04_27_17_42_34_800x530.jpg alt=/images/2015_04_27_17_42_34_800x530.jpg><br>在切换到的页面中，点击节点最右边的齿轮，配置该节点机器的网络、存储等，这里只配置网络：<br><img src=/images/2015_04_27_17_44_05_797x203.jpg alt=/images/2015_04_27_17_44_05_797x203.jpg><br>点击Configure Network配置网络:<br><img src=/images/2015_04_27_17_45_19_448x349.jpg alt=/images/2015_04_27_17_45_19_448x349.jpg><br>可以看到前4个节点已经配置好了，我们只需要把VM(Fix)这个框从eth0拖动到eth4即可:<br><img src=/images/2015_04_27_17_46_34_524x342.jpg alt=/images/2015_04_27_17_46_34_524x342.jpg><br>添加完毕后，网络配置应该如下图:<br><img src=/images/2015_04_27_17_48_22_489x436.jpg alt=/images/2015_04_27_17_48_22_489x436.jpg><br>点击Apply后，保存当前配置，然后点击Back to node list可以顺次添加其他节点。</p><p>下面是一个添加好的OpenStack HA环境示例(3 Controller + 2 Compute):<br><img src=/images/2015_04_27_17_57_01_948x432.jpg alt=/images/2015_04_27_17_57_01_948x432.jpg></p><p>这里要注意，因为我们要启用嵌套虚拟化，所以确保Compute节点是把Host CPU Configuration下发了的那台。<br>添加完三个OpenStack Controller节点和一个OpenStack Compute节点后，就可以点击Deploy Changes开始部署了。整个部署的过程至少需要1个小时，取决于机器配置和磁盘读写快慢。</p><p>部署完毕后，Fuel会弹出提示信息，并给出可访问OpenStack HA Horizon界面的URL。</p><h3 id=准备contrail部署节点>准备Contrail部署节点</h3><p>在OpenStack HA节点部署的同时，我们可以准备好Contrail部署节点。<br>同样创建出一个新的OpenStack HA部署环境，记住我们不能在已有的OpenStack HA环境里添加节点机，因为那样部署出来的节点机都会带上OpenStack的一些包，我们需要一个纯净的Ubuntu环境进行Contrail组件的配置。<br>同样添加3个Compute节点，进行同样的网络配置，添加完节点后，Deploy Changes按钮是不能被点下的，因为我们的环境里没有OpenStack Controller. 一个环境示例如下:<br><img src=/images/2015_04_27_17_59_13_837x489.jpg alt=/images/2015_04_27_17_59_13_837x489.jpg></p><p>我们需要登录到Fuel Controller的终端，就是10.20.0.2那台机器(用户名root,密码r00tme)，手动对添加的三个Contrail节点进行provision:</p><pre><code># fuel --env &lt;ENVIRONMENT_ID&gt; node --list
# fuel node --node-id &lt;NODE1_ID&gt;,&lt;NODE2_ID&gt;,&lt;NODE3_ID&gt; --env-id &lt;ENVIRONMENT_ID&gt; --provision

</code></pre><p>如何得到当前的ENVIRONMENT_ID, 下面提供了一个例子:</p><pre><code>[root@fuel ~]# fuel --env environment
id | status      | name                              | mode       | release_id | changes                                                                                                                                                               | pending_release_id
---|-------------|-----------------------------------|------------|------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------
36 | operational | JunoOpenStack                     | multinode  | 2          | []                                       
[root@fuel ~]# fuel --env 36 node --list
id | status | name             | cluster | ip        | mac               | roles      | pending_roles | online | group_id
---|--------|------------------|---------|-----------|-------------------|------------|---------------|--------|---------
3  | ready  | Untitled (e5:f2) | 36      | 10.20.0.3 | da:98:96:c5:c3:4b | compute    |               | False  | 36      
4  | ready  | Untitled (71:15) | 36      | 10.20.0.4 | 1a:ff:37:1f:26:44 | controller |               | False  | 36  
[root@fuel ~]# fuel node --node-id 3 --env-id 36 --provision2

</code></pre><p>同样需要大约30分钟时间用来在三台Contrail Controller的节点机上部署完可用的Ubuntu系统，部署完毕后，node界面上可以看到绿色的小字"ubuntu installed&rdquo;.</p><p>这一节我们通过Fuel部署完毕OpenStack HA, 并准备了用于后续部署OpenContrail的三台Contrail Controller节点。接下来我们可以进入到OpenStack和OpenContrail的集成了。</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/04/27/shi-yong-fuelbu-shu-opencontrail-3/>使用Fuel部署OpenContrail(3)</a></h1><span class=post-date>Apr 27, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>在OpenStack HA部署好的基础上集成OpenContrail是一个比较繁琐的过程，所以这一节里我们主要做集成前的准备工作，准备网络拓扑和创建好OpenContrail本地部署仓库。</p><h3 id=网络规划>网络规划</h3><p>在Miranti提供的集成参考里，有如下的图，定义了整个环境的网络拓扑。<br><img src=/images/2015_04_27_19_06_11_1147x804.jpg alt=images/2015_04_27_19_06_11_1147x804.jpg><br>从图中可以看到各个节点所接入到的物理网络。我们根据这些节点接入网络的不同，来定义对应系统上的网络配置。<br>在安装完毕后的虚拟机里，可以看到该节点的DNS名称，例如node-19, node-20之类，在Fuel Controller上可以通过<code>ssh root@node-19</code>来登入相应角色的机器上。<br>以下是三个OpenStack节点的网络部署, N/A代表不需要配置，可以直接把对应的接口文件删除:<br>对应的接口分别是从eth0 ~ eth4.</p><p>OS1: node-19, PXE:10.20.0.14, Public: 172.16.0.6, Management: 10.55.55.6, Storage: 10.66.66.5, Private: N/A.<br>OS2: node-20, PXE:10.20.0.15, Public: 172.16.0.7, Management: 10.55.55.7, Storage: 10.66.66.6, Private: N/A.<br>OS3: node-22, PXE:10.20.0.16, Public: 172.16.0.8, Management: 10.55.55.8, Storage: 10.66.66.7, Private: N/A.</p><p>Compute: node-18, PXE: 10.20.0.13, Public: 172.16.0.5, Management: 10.55.55.5, Storage: 10.66.66.4, Private: N/A.</p><p>Contrail1: node-24, PXE: 10.20.0.10, Public: N/A, Management: N/A, Storage: N/A, Private: 10.77.77.10
Contrail2: node-21, PXE: 10.20.0.11, Public: N/A, Management: N/A, Storage: N/A, Private: 10.77.77.11
Contrail3: node-23, PXE: 10.20.0.12, Public: N/A, Management: N/A, Storage: N/A, Private: 10.77.77.12</p><p>OpenStack和Compute各个节点的配置是自动配置好的，Contrail节点上的Private节点则需要手动配置，具体步骤如下:</p><pre><code>root@node-24:~# vim /etc/network/interfaces.d/ifcfg-eth4 
auto eth4
iface eth4 inet static

address 10.77.77.10
netmask 255.255.255.0
gateway 10.77.77.1

post-up  ethtool  -K  eth4  gso off  gro off || true

</code></pre><p>删除三个Contrail Controller节点上的未用端口, 并重启后得到我们要的配置:</p><pre><code>root@node-24:~# rm -f /etc/network/interfaces.d/ifcfg-eth3 
root@node-24:~# rm -f /etc/network/interfaces.d/ifcfg-eth2
root@node-24:~# rm -f /etc/network/interfaces.d/ifcfg-eth1 

</code></pre><p>到这里，我们节点机的网络单机就配置完毕了。</p><h3 id=网间互通>网间互通</h3><p>我们需要让Management网络和Private网络可以通过某种途径互相连通，这里为了部署的方便，直接在主机(Host机器)上用iptables加上以下规则：</p><pre><code># iptables -D FORWARD -i virbr5 -j REJECT --reject-with icmp-port-unreachable
# iptables -D FORWARD -o virbr5 -j REJECT --reject-with icmp-port-unreachable
# iptables -D FORWARD -o virbr3 -j REJECT --reject-with icmp-port-unreachable
# iptables -D FORWARD -i virbr3 -j REJECT --reject-with icmp-port-unreachable
# iptables -t nat -A POSTROUTING -s 10.55.55.0/24 -d 10.77.77.0/24 -j MASQUERADE
# iptables -t nat -A POSTROUTING -s 10.77.77.0/24 -d 10.55.55.0/24 -j MASQUERADE

</code></pre><p>值得注意的是，virbr5和virbr3就是10.55.55.0/24和10.77.77.0/24所附属的网口，具体可以在Virt-Manager的配置菜单里看到。<br>添加完毕后，在OpenStack的节点(OS1,OS2,OS3)ping Private网络里的地址，如<code>ping 10.77.77.10</code>, 确保可以ping通；在Contrail Controller的节点(Contrail1, Contrail2, Contrail3)上ping Management网络里的地址，如10.55.55.6，确保可以ping通。<br>集成OpenContrail的一个先决条件是Private网络和Management网络可以互通。</p><h3 id=opencontrail安装仓库准备>OpenContrail安装仓库准备</h3><p>我们在Fuel Controller上建立OpenContrail的安装仓库，这样有利于快速部署， 具体的操作是从Juniper官方提供的deb包里释出OpenContrail安装所需要的包，形成一个本地仓库。具体步骤如下:</p><pre><code># yum -y install dpkg-devel
# cd ~/Deb
# mkdir -p /var/www/nailgun/contrail
# mv /root/contrail-install-packages_2.0-22~icehouse_all.deb  ./
# ar vx contrail-install-packages_2.0-22~icehouse_all.deb
# rm -f contrail-install-packages_2.0-22~icehouse_all.deb 
# tar xf data.tar.gz
# tar xf opt/contrail/contrail_packages/contrail_debs.tgz -C /var/www/nailgun/contrail
# cd /var/www/nailgun/contrail
# dpkg-scanpackages . /dev/null | gzip -9c &gt; Packages.gz
# rm -rf ~/Deb

</code></pre><p>这时候如果在本机上访问<br><a href=http://10.20.0.2:8080/contrail/>http://10.20.0.2:8080/contrail/</a><br>就可以看到整个仓库的包列表及详情。这个仓库将在后面部署Contrail时被用到。</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2015/04/27/shi-yong-fuelbu-shu-opencontrail-4/>使用Fuel部署OpenContrail(4)</a></h1><span class=post-date>Apr 27, 2015<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>前面已经准备好了集成OpenContrail的所有事宜，接下来就是真正部署OpenContrail的过程了。部署OpenContrail需要修改所有的Contrail Controller节点，OpenStack Controller节点， OpenStack Compute节点，为了避免混淆，本节主要完成在Contrail Controller上的部署工作。</p><h3 id=openstack-controller节点部署后配置>OpenStack Controller节点部署后配置</h3><p>在所有的OpenStack Controller节点(OS1,OS2,OS3)上，打开/usr/lib/ocf/resource.d/mirantis/ns_haproxy文件，编辑以下字段:<br>OCF_Parameters部分:</p><pre><code>OCF_RESKEY_private_network_default=&quot;10.55.55.0/24&quot;
OCF_RESKEY_private_network_gateway_default=&quot;10.55.55.1&quot;

</code></pre><p>在meta_data()函数中，添加以下内容:</p><pre><code>&lt;parameter name=&quot;private_network&quot;&gt;
&lt;longdesc lang=&quot;en&quot;&gt;
Private L3 network that should be configured inside the namespace
&lt;/longdesc&gt;
&lt;shortdesc lang=&quot;en&quot;&gt;Namespace private network&lt;/shortdesc&gt;
&lt;content type=&quot;string&quot; default=&quot;${OCF_RESKEY_private_network_default}&quot; /&gt;
&lt;/parameter&gt;

&lt;parameter name=&quot;private_network_gateway&quot;&gt;
&lt;longdesc lang=&quot;en&quot;&gt;
Private L3 network gateway that should be configured inside the namespace.
&lt;/longdesc&gt;
&lt;shortdesc lang=&quot;en&quot;&gt;Namespace private gateway network&lt;/shortdesc&gt;
&lt;content type=&quot;string&quot; default=&quot;${OCF_RESKEY_private_network_gateway_default}&quot; /&gt;
&lt;/parameter&gt;

</code></pre><p>set_ns_routing()函数中，添加一下内容:</p><pre><code>nsip route list | grep -q &quot;${OCF_RESKEY_private_network}&quot;
if [ $? -gt 0 ]; then
ocf_log debug &quot;Creating ${OCF_RESKEY_private_network} route inside the namespace&quot;
ocf_run nsip route add &quot;${OCF_RESKEY_private_network}&quot; via &quot;${OCF_RESKEY_private_network_gateway}&quot;
fi

</code></pre><p>以上的修改是为了引入haproxy的namespace的。</p><h3 id=配置contrail部署节点>配置Contrail部署节点</h3><p>我们引入了三个Contrail Controller节点，从中挑选一个，作为部署的管理节点，OpenContrail通过fabric下发安装指令给各节点机，因此我们首先要准备的是部署节点。这里的例子中，我们选择Contrail1(10.20.0.10)作为部署节点。</p><pre><code># echo 'deb http://10.20.0.2:8080/contrail/ /' &gt; /etc/apt/sources.list.d/contrail.list
# echo -e &quot;Package: *\nPin: release l=Ubuntu\nPin-Priority: 100&quot; &gt; /etc/apt/preferences
# &gt;/etc/apt/sources.list
# apt-get update
# apt-get install -y python-paramiko contrail-fabric-utils contrail-setup
# pip install --upgrade --no-deps --index-url=”” /opt/contrail/python_packages/Fabric-1.7.0.tar.gz

</code></pre><p>apt-get udpate前我们需要清空本机上的sources.list文件，因为经过前两步后，本机的sources.list中会加上10.20.0.2的默认源，这会引发update失败，因此我们清空此文件。<br>安装完一些准备包后，部署节点进入就绪状态。</p><h3 id=编写testbedpy>编写testbed.py</h3><p>testbed.py文件定义了整个OpenContrail的组建部署节点信息，在编写此文件前，我们需要得到以下信息:<br>A. OpenStack的Service_Token, 在任何一台OpenStack Controller机器上，运行以下命令以得到系统当前的service_token值:</p><pre><code>root@node-20:~# cat /etc/keystone/keystone.conf  | grep -i &quot;admin_token=&quot; | more
#admin_token=ADMIN
admin_token=rVlaAKUs

</code></pre><p>记下rVlaAKUs这个值，在testbed.py文件中我们会用到。</p><p>B. OpenStack Controller的Public vip和Management vip, 如下所示，结合我们的网络规划，Public vip是172网段，而Management vip则是10.55.55网段的IP:</p><pre><code>root@node-20:~# source /root/openrc 
root@node-20:~# keystone endpoint-list | grep 5000
| 0e3c0684e8ae4c9fa4e080c9e1c66513 | RegionOne |         http://172.16.0.4:5000/v2.0          |         http://10.55.55.4:5000/v2.0          |       http://10.55.55.4:35357/v2.0      | f822df80ee1042d9b10d57118bb410aa |


</code></pre><p>C. Contrail Controller的内部vip和外部vip, 因为我们把Contrail Controller的Private IP分配在10.77.77.0/24网段，所以我们暂时选用10.77.77.9作为两个vip的地址。</p><p>D. 如果有外部路由器，则需要配置外部路由器的IP地址。这次的部署中我们不采用外部路由器，因而对比于官方的推荐配置文件，我们的testbed.py中删除了这一部分。</p><p>综合考虑到上述因素后，我们的testbed.py文件定义如下:</p><pre><code>root@node-24:~# vim /opt/contrail/utils/fabfile/testbeds/testbed.py|more
from fabric.api import env
#Management ip addresses of hosts in the cluster
os_ctrl01 = 'root@10.55.55.6'
os_ctrl02 = 'root@10.55.55.7'
os_ctrl03 = 'root@10.55.55.8'
c_ctrl01 = 'root@10.77.77.10'
c_ctrl02 = 'root@10.77.77.11'
c_ctrl03 = 'root@10.77.77.12'
c_db01 = 'root@10.77.77.10'
c_db02 = 'root@10.77.77.11'
c_db03 = 'root@10.77.77.12'
#External routers
# ext_routers = [('gateway01', '&lt;Gateway_node1_LOOPBACK_ip&gt;'), ('gateway02', '&lt;Gateway_node2_LOOPBACK_ip&gt;')]
#Autonomous system number
router_asn = 64512
#Host from which the fab commands are triggered to install and provision
deploy_node = 'root@10.77.77.10'
#Role definition of the hosts.
env.roledefs = {
'all': [c_ctrl01, c_ctrl02, c_ctrl03, c_db01, c_db02, c_db03],
'cfgm': [c_ctrl01, c_ctrl02, c_ctrl03],
'openstack': [os_ctrl01, os_ctrl02, os_ctrl03],
'control': [c_ctrl01, c_ctrl02, c_ctrl03],
'compute': [],
'collector': [c_ctrl01, c_ctrl02, c_ctrl03],
'webui': [c_ctrl01, c_ctrl02, c_ctrl03],
'database': [c_db01, c_db02, c_db03],
'build': [deploy_node],
'storage-master': [],
'storage-compute': [],
}
#Openstack admin password
env.openstack_admin_password = 'admin'
env.password = 'r00tme'
#Passwords of each host
env.passwords = {
os_ctrl01: 'r00tme',
os_ctrl02: 'r00tme',
os_ctrl03: 'r00tme',
c_ctrl01: 'r00tme',
c_ctrl02: 'r00tme',
c_ctrl03: 'r00tme',
c_db01: 'r00tme',
c_db02: 'r00tme',
c_db03: 'r00tme',
deploy_node: 'r00tme',
}
#For reimage purpose
env.ostypes = {
os_ctrl01: 'ubuntu',
os_ctrl02: 'ubuntu',
os_ctrl03: 'ubuntu',
c_ctrl01: 'ubuntu',
c_ctrl02: 'ubuntu',
c_ctrl03: 'ubuntu',
c_db01: 'ubuntu',
c_db02: 'ubuntu',
c_db03: 'ubuntu',
deploy_node: 'ubuntu',
}
env.openstack = {
'service_token' : 'rVlaAKUs'
}
env.ha = {
'internal_vip': '10.55.55.4',
'external_vip': '172.16.0.4',
'contrail_internal_vip': '10.77.77.9',
'contrail_external_vip': '10.77.77.9',
}
env.keystone = {
'service_tenant': 'services',
'admin_token': 'rVlaAKUs',
}
multi_tenancy = True

</code></pre><p>编写完testbed.py文件后，就可以根据文件中的定义，部署OpenContrail的组件到多台节点主机了。<br>Fuel Controller节点上的id_rsa文件可以实现对各个节点的无密码登录，拷贝它到我们的Contrail部署节点上:</p><pre><code># scp 10.20.0.2:/root/.ssh/id_rsa /root/.ssh/id_rsa
# chmod 0600 /root/.ssh/id_rsa

</code></pre><h3 id=部署多节点>部署多节点</h3><p>首先切换到/opt/contrail/utils目录下，所有用fab执行的部署都需要在这个目录下执行。执行以下操作, 以初始化各部署子节点:</p><pre><code># cd /opt/contrail/utils
# fab -P -R control -w -- &quot;ls /etc/apt/sources.list.d/contrail.list || echo 'deb \
http://10.20.0.2:8080/contrail/ /' &gt; \
/etc/apt/sources.list.d/contrail.list&quot;
# fab -P -R control -w -- 'ls /etc/apt/preferences || echo -e &quot;Package: *\nPin: release \
l=Ubuntu\nPin-Priority: 100&quot; &gt; /etc/apt/preferences'
# fab -P -R control -w -- 'DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes \
--allow-unauthenticated install python-crypto python-netaddr python-paramiko \
contrail-fabric-utils contrail-setup'
# fab -P -R control -w -- 'pip install --upgrade --no-deps --index-url=&quot;&quot; \
/opt/contrail/python_packages/ecdsa-0.10.tar.gz'
# fab -P -R control -w -- 'pip install --upgrade --no-deps --index-url=&quot;&quot; \
/opt/contrail/python_packages/Fabric-1.7.0.tar.gz'

</code></pre><p>如果出现apt-get update的问题，可以如上面提到的，手动登录到各个节点上去清空/etc/apt/sources.list文件，当然一般情况下不会出现这个问题。<br>运行以下命令，接受sun的协议:</p><pre><code># fab -P -R control -w -- 'echo &quot;sun-java6-plugin shared/accepted-sun-dlj-v1-1 boolean \
true&quot; | /usr/bin/debconf-set-selections' &amp;&amp; fab -P -R control -w -- 'echo &quot;sun-java6-bin shared/accepted-sun-dlj-v1-1 boolean \
 true&quot; | /usr/bin/debconf-set-selections' &amp;&amp; fab -P -R control -w -- 'echo &quot;debconf shared/accepted-oracle-license-v1-1 select \
true&quot; | sudo debconf-set-selections' &amp;&amp; fab -P -R control -w -- 'echo &quot;debconf shared/accepted-oracle-license-v1-1 seen \
 true&quot; | sudo debconf-set-selections'

</code></pre><p>OpenContrail组件依赖于特定版本的tzdata， 用以下命令安装：</p><pre><code># fab -P -R control -w -- 'DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes \
 --allow-unauthenticated install tzdata=2014e-0ubuntu0.12.04'

</code></pre><p>安装和设置database, 并检查节点的状态:</p><pre><code> # fab install_database &amp;&amp; fab setup_database
 # fab -R database -w -- &quot;contrail-status&quot;
 # nodetool status
--  Address      Load       Tokens  Owns   Host ID                               Rack
UN  10.77.77.12  141.84 MB  256     33.3%  4ea3abec-16ee-417a-b78c-69e8dca292be  rack1
UN  10.77.77.11  141.33 MB  256     35.8%  d7677bf2-1447-48af-b1d4-356b4a8d6cff  rack1
UN  10.77.77.10  134.28 MB  256     30.9%  e418e4ef-af22-4874-ad94-777d6b4c511c  rack1

</code></pre><p>当看到上面有三个条目时，代表安装成功，可以进行下一步。</p><p>安装cfgm, control, collector, webui 组件以及keepalived集群。</p><pre><code># fab install_cfgm &amp;&amp; fab install_control &amp;&amp; fab install_collector &amp;&amp; fab install_webui &amp;&amp; fab setup_contrail_keepalived &amp;&amp; fab fixup_restart_haproxy_in_collector 2&gt;&amp;1 | tee all.txt

</code></pre><p>删除掉/etc/keepalived/keepalived.conf里的EXTERNAL部分, 值得注意的是，在三个Contrail Controller上，都需要执行此操作:</p><pre><code># vim /etc/keepalived/keepalived.conf
......remove something......

</code></pre><p>删除以后，重新启动keepalived服务:</p><pre><code># fab -P -R control -w -- 'service keepalived restart'

</code></pre><p>更新haproxy的配置文件，添加WebUI的虚拟IP地址(vip). 值得注意的是，在三个Contrail Controller上，都需要执行此操作:</p><pre><code># vim /etc/haproxy/haproxy.cfg
#contrail-webui-marker-start
frontend contrail-webui-api *:443
    mode tcp
    default_backend contrail-webui-api
backend contrail-webui-api
    mode tcp
    balance roundrobin
    option nolinger
    stick on src
    stick-table type ip size 200k expire 300m
    option tcp-check
    tcp-check connect port 8143
    default-server error-limit 1 on-error mark-down
    server 10.77.77.10 10.77.77.10:8143 check inter 2000 rise 2 fall 3
    server 10.77.77.11 10.77.77.11:8143 check inter 2000 rise 2 fall 3
    server 10.77.77.12 10.77.77.12:8143 check inter 2000 rise 2 fall 3
#contrail-webui-marker-end

</code></pre><p>更改完以后，重启haproxy服务:</p><pre><code># fab -P -R control -w -- 'service haproxy restart'

</code></pre><p>更改每个节点上的tenant服务名称，从&rsquo;service'改成&rsquo;services&rsquo;:</p><pre><code># fab -P -R control -w -- &quot;sed -i '49s/service/services/g' \
/usr/local/lib/python2.7/dist-packages/contrail_provisioning/config/quantum_in_keystone_setup.py&quot;

</code></pre><p>配置cfgm服务:</p><pre><code># fab setup_cfgm

</code></pre><p>这时我们可以验证neutron endpoint是否被正确安装，在任何一个OpenStack Controller节点上，运行以下命令:</p><pre><code># keystone service-list
# keystone endpoint-list

</code></pre><p>例如:</p><pre><code>root@node-20:~# keystone service-list | grep neutron
| 2f4c887f68a9428aa448cbd688d7061f | neutron  |    network     |             network              |
root@node-20:~# keystone endpoint-list | grep 2f4c887f68a9428aa448cbd688d7061f
| 7dd2c25e69ad4a3296f272aa253001c8 | RegionOne |            http://10.77.77.9:9696            |            http://10.77.77.9:9696            |          http://10.77.77.9:9696         | 2f4c887f68a9428aa448cbd688d7061f |

</code></pre><p>成功的话，接着下一步设置，删除所有的Contrail Controller节点上文件/etc/haproxy/haproxy.cfg里的rabbit字段：</p><pre><code># vim /etc/haproxy/haproxy.cfg
......remove something......

</code></pre><p>重新启动haproxy服务:</p><pre><code># fab -P -R control -w -- 'service haproxy restart'

</code></pre><p>设置control,collector,webui组件服务:</p><pre><code># fab setup_control
# fab setup_collector &amp;&amp; fab setup_webui

</code></pre><p>在任一OpenStack Controller节点上，运行以下命令，得到rabbit的密码:</p><pre><code>root@node-22:~# cat /etc/rabbitmq/rabbitmq.config | grep default_pass
    {default_pass,        &lt;&lt;&quot;gYFQP10P&quot;&gt;&gt;},

</code></pre><p>配置neutron插件，使用运行在OpenStack Controller上的rabbit 集群, 这里的rabbit_password使用上面得到的值:</p><pre><code>#  fab -P -R control -w -- 'openstack-config --del /etc/neutron/neutron.conf DEFAULT rabbit_host'
#  fab -P -R control -w -- 'openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_hosts \
  10.55.55.6:5673,10.55.55.7:5673,10.55.55.8:5673'
#  fab -P -R control -w -- 'openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_userid \
   nova'
#  fab -P -R control -w -- 'openstack-config --set /etc/neutron/neutron.conf DEFAULT \
  rabbit_password gYFQP10P'
# fab -P -R control -w -- 'service neutron-server restart'

</code></pre><p>配置contrail-api以使用运行在OpenStack Controller上的rabbit集群:</p><pre><code># fab -P -R control -w -- 'perl -pi -e \
 &quot;s/rabbit_server.*$/rabbit_server=10.55.55.4/&quot; /etc/contrail/contrail-api.conf'
# fab -P -R control -w -- 'perl -pi -e &quot;s/rabbit_port.*$/rabbit_port=5672/&quot; \
 /etc/contrail/contrail-api.conf'
# fab -R control -w -- &quot;perl -pi -e 'print \&quot;rabbit_password=gYFQP10P\n\&quot; \
 if \$_ =~ rabbit_port' /etc/contrail/contrail-api.conf&quot;
# fab -P -R control -w -- &quot;perl -pi -e 'print \&quot;rabbit_user=nova\n\&quot; if \$_ =~ rabbit_port' \
 /etc/contrail/contrail-api.conf&quot;
# fab -P -R control -w -- &quot;service contrail-api restart&quot;

</code></pre><p>使用前面下载的OpenContrail 插件，作为neutron挂载的插件, 或者你可以直接从github克隆下来:</p><pre><code># mkdir -p /tmp/contrail-repo
# apt-get install -y git
# git clone https://github.com/Juniper/contrail-neutron-plugin.git /tmp/contrail-repo
# cd /tmp/contrail-repo
# git checkout 3189155
# cp -r /tmp/contrail-repo/neutron_plugin_contrail/plugins/opencontrail \
/usr/share/pyshared/neutron_plugin_contrail/plugins/

</code></pre><p>重新启动neutron-service:</p><pre><code># cd /opt/contrail/utils
# fab -P -R cfgm -w -- 'service neutron-server restart'

</code></pre><p>设置Contrail Controller之间的BGP节点发现，metadata服务及encapsulation类型:</p><pre><code># fab prov_control_bgp &amp;&amp; fab prov_metadata_services &amp;&amp; fab prov_encap_type

</code></pre><p>用以下命令验证安装是否成功:</p><pre><code># fab verify_cfgm
# fab verify_control
# fab verify_collector
# fab verify_webui
# fab -R control -w -- &quot;contrail-status&quot;

</code></pre><p>更新rc.d，这样在启动的时候，不会启动supervisor-support进程：</p><pre><code># fab -P -R control -w -- 'update-rc.d supervisor-support-service disable'

</code></pre><p>用浏览器访问以下页面，以确认Contrail已经被正确安装:<br><a href=https://10.77.77.9>https://10.77.77.9</a><br>此时你看到的页面应该如下：<br><img src=/images/2015_04_27_21_49_07_1006x746.jpg alt=/images/2015_04_27_21_49_07_1006x746.jpg></p><p>本章过完以后，我们的OpenContrail部署已经完成了大半，接下来就是在Compute和OpenStack Controller节点上的配置，达到最后的集成过程。</p></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/141/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/141/>141</a></li><li class="page-item active"><a class=page-link href=/page/142/>142</a></li><li class=page-item><a class=page-link href=/page/143/>143</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/231/>231</a></li><li class=page-item><a href=/page/143/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/231/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>