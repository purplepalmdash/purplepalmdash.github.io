<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>为Blog添加保存为图片功能 &middot; Dash</title>

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/poole.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/highlight/googlecode.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="/js/html2canvas.js"></script>
  <script type='text/javascript'>
  function genPostShot() { 
          var rightNow = new Date();
          var imageName = rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");
          imageName += '.jpg'
          html2canvas(document.getElementsByClassName('post'), {
              background :'#FFFFFF',
              onrendered: function(canvas) {
  		
          	$('#test').attr('href', canvas.toDataURL("image/jpeg"));
          	$('#test').attr('download',imageName);
          	$('#test')[0].click();
              }
          });
  }; 
  
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124">
  <link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel="icon">

  
  
  
  
  <meta name="description" content="Add turn to picture for blogging">
  <meta name="keywords" content="Linux">
  
  
</head>
<body class="theme-base-0c">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <img src="http://purplepalmdash.github.io/images/mylogo.jpeg" alt="gravatar">
      <h1><a href="http://purplepalmdash.github.io/">Get busy living, or get busy dying.</a></h1>
      <a href="http://purplepalmdash.github.io/"><p>Dash</p></a>
    </div>

    <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/post/">All Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/technology/">Technology</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/life/">Life</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/linuxtips/">LinuxTips</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/purplepalmdash"><i class="fa fa-github-square fa-3x"></i></a>
      
      <a href="https://cn.linkedin.com/in/yang-feipeng-1b909319"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://plus.google.com/u/0/106572959364703833986"><i class="fa fa-google-plus-square fa-3x"></i></a>
      <a href="https://www.facebook.com/yang.feipeng"><i class="fa fa-facebook-square fa-3x"></i></a>
      <a href="https://twitter.com/dashwillfly"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      </li>
    </ul>

    

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>为Blog添加保存为图片功能</h1>
    <p align="right">
    <a href="javascript:genPostShot()">
	    TurnToJPG --> <i class="fa fa-camera-retro fa-2x"></i>
    </a>
    <a id="test"></a>
    </p>
    <hr>
    <span class="post-date">Nov 5, 2016 
    
    <br/>
    
          <a class="a_cat" href="http://purplepalmdash.github.io/categories/technology">Technology</a>
      
      

    
    </span>
      <div id="_toc" class="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景">背景</a></li>
        <li><a href="#功能参考">功能参考</a></li>
        <li><a href="#可选方案">可选方案</a></li>
        <li><a href="#code">Code</a></li>
        <li><a href="#效果">效果</a></li>
        <li><a href="#trouble-shooting">Trouble-Shooting</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    <h3 id="背景">背景</h3>
<p>众所周知疼讯其实一直是一个很封闭傻逼的企业，早年QZONE的代码就层层加密，
惟恐互联网爬虫爬到它上面取内容。进入到移动互联网时代，就更加变本加厉，盆友
圈里的诸多内容，恐怕诸位都是没办法弄出来的。</p>
<p>早年曾在Blog上添加过<code>分享到朋友圈</code>或<code>分享到微信好友</code>按钮，由于<code>github.io</code>未
被疼讯认可，共享出来的链接通常只有自己能看到，这又是一个拿用户当SB的典型
案例。</p>
<p>还好，对于用户上传图片，疼讯是没法限制的。所以有了以下的开发。</p>
<h3 id="功能参考">功能参考</h3>
<p>在博文里添加按钮<code>一键保存为图片</code>,即可将该篇文章生成为长图片。</p>
<p><img src="/images/2016_11_05_18_38_31_637x390.jpg" alt="/images/2016_11_05_18_38_31_637x390.jpg"></p>
<p>参考设计： 锤子便签。顺便吐槽一下锤子便签，添加了关键词过滤，关键词嘛，这也是
党国拿来折腾屁民的一个傻逼玩意，例如有一首歌是这么唱的:</p>
<pre><code>我爱北京关键词，
关键词上太阳升。。
伟大得领袖关键词，
带领我们向前进…
</code></pre><p>╮〔╯ε╰〕╭   &mdash;太多的关键词，容易让写博文的人心情不好。</p>
<h3 id="可选方案">可选方案</h3>
<p>A. wkhtmltoimage. <br>
这个转换起来是全屏转换，所以最初想到的是对网页做再加工，抠取出其中含有内容的一部分。
好处是，真的是所见即所得。</p>
<pre><code>$ wkhtmltoimage http://www.google.com google.jpg
</code></pre><p>B. html2canvas. <br>
这种方案直接在html页面上做文章，添加按钮后直接用画布来生成对象。缺点是有些格式显示出来
有少量阴影。</p>
<p>暂时基于方案B实现。</p>
<h3 id="code">Code</h3>
<p>参考资料: <br>
<a href="https://www.youtube.com/watch?v=-d2FeFiBvEo">https://www.youtube.com/watch?v=-d2FeFiBvEo</a> <br>
<a href="https://html2canvas.hertzen.com/">https://html2canvas.hertzen.com/</a></p>
<p>因为本博客基于hugo构建，直接修改hugo使用的主题即可添加html2canvas。</p>
<p>目录结构:</p>
<pre><code>$ ls  
config.toml  content  id_rsa.enc  scripts  static  themes
$ themes/hyde-a
$ ls
archetypes  images  layouts  LICENSE  README.md  static  theme.toml
</code></pre><p>下载<code>html2canvas.js</code>到主题的<code>static/js</code>目录:</p>
<pre><code>$ cd static/js
$ wget
https://github.com/niklasvh/html2canvas/releases/download/0.4.1/html2canvas.js
</code></pre><p>在主题的<code>./layouts/partials/head.html</code>文件中添加所需要的js文件及javascript代码
, (+代表新添加代码):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">link</span> <span style="color:#a6e22e">rel</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css&#34;</span><span style="color:#f92672">&gt;</span>
<span style="color:#f92672">+</span>  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&#34;</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;</span>
<span style="color:#f92672">+</span>  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/js/html2canvas.js&#34;</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;</span>
<span style="color:#f92672">+</span>  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;text/javascript&#39;</span><span style="color:#f92672">&gt;</span><span style="color:#75715e">//&lt;![CDATA[
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">genPostShot</span>() { 
<span style="color:#f92672">+</span>          <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rightNow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date();
<span style="color:#f92672">+</span>          <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">imageName</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rightNow</span>.<span style="color:#a6e22e">toISOString</span>().<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">16</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/(-)|(:)|(T)/g</span>,<span style="color:#e6db74">&#34;&#34;</span>);
<span style="color:#f92672">+</span>          <span style="color:#a6e22e">imageName</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;.jpg&#39;</span>
<span style="color:#f92672">+</span>          <span style="color:#a6e22e">html2canvas</span>(document.<span style="color:#a6e22e">getElementsByClassName</span>(<span style="color:#e6db74">&#39;post&#39;</span>), {
<span style="color:#f92672">+</span>              <span style="color:#a6e22e">onrendered</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">canvas</span>) {
<span style="color:#f92672">+</span>  		<span style="color:#75715e">// Click them for download
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span>          	<span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#test&#39;</span>).<span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;href&#39;</span>, <span style="color:#a6e22e">canvas</span>.<span style="color:#a6e22e">toDataURL</span>(<span style="color:#e6db74">&#34;image/jpeg&#34;</span>));
<span style="color:#f92672">+</span>          	<span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#test&#39;</span>).<span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;download&#39;</span>,<span style="color:#a6e22e">imageName</span>);
<span style="color:#f92672">+</span>          	<span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#test&#39;</span>)[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">click</span>();
<span style="color:#f92672">+</span>              }
<span style="color:#f92672">+</span>          });
<span style="color:#f92672">+</span>  }; 
<span style="color:#f92672">+</span>  <span style="color:#75715e">//]]&gt;
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span>  <span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;</span>
  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js&#34;</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;</span>
</code></pre></div><p>简单解释一下这几行代码：</p>
<ol>
<li>取当时UTC时间作为下载jpg文件名。</li>
<li>在当前页面中根据div的class名称找到<code>post</code>字段，构建一个画布。</li>
<li>将画布内容输出为jpeg文件，触发浏览器的一个下载动作。</li>
</ol>
<p><strong>注意</strong>: <code>#test</code>为在html文件中添加的一个不可见链接.</p>
<p>接下来修改每个博文用到的模板文件(layourts/post/single.html):</p>
<pre><code>{{ partial &quot;head.html&quot; . }}
&lt;div class=&quot;content container&quot;&gt;
  &lt;div class=&quot;post&quot;&gt;
    &lt;h1&gt;{{ .Title }}&lt;/h1&gt;
+    &lt;p align=&quot;right&quot;&gt;
+    &lt;a href=&quot;javascript:genPostShot()&quot;&gt;
+	    TurnToJPG --&gt; &lt;i class=&quot;fa fa-camera-retro fa-2x&quot;&gt;&lt;/i&gt;
+    &lt;/a&gt;
+    &lt;a id=&quot;test&quot;&gt;&lt;/a&gt;
+    &lt;/p&gt;
+    &lt;hr&gt;
    &lt;span class=&quot;post-date&quot;&gt;{{ .Date.Format &quot;Jan 2, 2006&quot; }} {{ if .Site.DisqusShortname }} &amp;middot; &lt;a href=&quot;{{ .Permalink }}#disqus_thread&quot;&gt;Comments&lt;/a&gt;{{ end }}
</code></pre><p>简单解释一下上述添加的代码:</p>
<p>添加一个超链接，指向上文定义的javascript函数<code>genPostShot()</code>.</p>
<p>保存修改，提交到上游仓库，重新生成整个静态网站，现在每个博文里都含有保存图片按钮。</p>
<h3 id="效果">效果</h3>
<p>譬如，点击<a href="http://purplepalmdash.github.io/2013/11/17/run-in-winter/">http://purplepalmdash.github.io/2013/11/17/run-in-winter/</a></p>
<p>效果如下:</p>
<p><img src="/images/2016_11_05_18_56_04_638x402.jpg" alt="/images/2016_11_05_18_56_04_638x402.jpg"></p>
<p>点击按钮，下载为文件201611051057.jpg(当前UTC时间戳），效果如下:</p>
<p><img src="/images/2016_11_05_18_58_11_250x375.jpg" alt="/images/2016_11_05_18_58_11_250x375.jpg"></p>
<p>打完，收工，以后在盆友圈想怎么咆哮就可以怎么咆哮了。</p>
<h3 id="trouble-shooting">Trouble-Shooting</h3>
<p>之所以加这么个条目是因为，在未定义背景的网页里，有时候截出来的图是黑色背景的，修正：</p>
<p>修改<code>./static/js/html2canvas.js</code>文件:</p>
<pre><code>sTransparent = function(backgroundColor) {
  return (backgroundColor === &quot;transparent&quot; || backgroundColor === &quot;rgba(0, 0,
0, 0)&quot;);
};
</code></pre><p>改为:</p>
<pre><code>_html2canvas.Util.isTransparent = function(backgroundColor) {
  return (backgroundColor === &quot;transparent&quot; || backgroundColor === &quot;rgba(0, 0,
0, 0)&quot; || backgroundColor === undefined);
};
</code></pre><p>之后我们在<code>./layouts/partials/head.html</code>中，添加这一行:</p>
<pre><code>          html2canvas(document.getElementsByClassName('post'), {
+              background :'#FFFFFF',
              onrendered: function(canvas) {
</code></pre><p>现在生成的图片背景就是白色的了。</p>

  </div>
  
</div>






<script src="http://purplepalmdash.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

