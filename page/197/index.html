<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2014/05/13/write-python-weather-app-on-heroku-11/>Write Python Weather APP on Heroku(11)</a></h1><span class=post-date>May 13, 2014<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=draw-flot-picture>Draw Flot Picture</h3><p>Since the article is mainly on writing apps, I don&rsquo;t want to spend much time on how to use javascript or flot for drawing picture.<br>Simply checkout the code on github, you will see the code which is used for retrieving the data and start drawing plot pictures.</p><h3 id=fetching-24-hours-data>Fetching 24-hours Data</h3><p>Fetching 24 latest records from the postgres database, and then add them into the chart, chart then has been sent to simplejson which used for updating the flot picture locally .</p><pre><code>@app.route('/ajax/24hours/')
# ajax updateing for 24-hour data
def TwentyFourHours():
    # Here we will visit postgres for retrieving back the last 24 hours' data
    # Local version
    # engine = create_engine('postgresql+psycopg2://Trusty:@localhost:5432/mylocaldb', echo=True)
    # Heroku Version
    db_conn = os.environ['DATABASE_URL']
    engine = create_engine(db_conn)
    # Engine selection
    metadata=MetaData(bind=engine)
    weather_table=Table('weather',metadata,
        Column('Insert_Time', DateTime(timezone=True),primary_key=True),
        Column('Temperature', Integer),
        Column('Humidity', Integer),
        Column('PmTen', Integer),
        Column('PmTwoFive', Integer),
    )
    s = select([weather_table]).order_by(weather_table.c.Insert_Time.desc()).limit(24)
    conn = engine.connect()
    result = conn.execute(s)
    chart = []
    for row in result:
        # row[0], datetime; 
        # row[1], Temperature;
        # row[2], Humidity;
        # row[3], PM10;
        # row[4], PM2.5; 

        ###  append row[x] into the char ###
        # chart.append({
        chart.insert(0, {
            &quot;label&quot;: (row[0] + timedelta(hours = 8)).strftime(&quot;%H:%M&quot;),
            &quot;value&quot;: row[1],
            &quot;humi_value&quot;: row[2],
            &quot;pm25_value&quot;: row[4],
            &quot;pm10_value&quot;: row[3]
            })

    jsonStr = simplejson.dumps({
        # This is char, will be used in script.js
        &quot;chart&quot; :{
            # tooltip is used by the jQuery chart:
            &quot;tooltip&quot;   : &quot;Temperature at %1: %2 degree&quot;,
            # humi_tooltip is used for jQuery chart for humidity:
            &quot;humi_tooltip&quot; : &quot;Humidity at %1: %2 \%&quot;,
            &quot;pm25_tooltip&quot; : &quot;PM2.5 at %1: %2 ug/m(3)&quot;,
            &quot;pm10_tooltip&quot; : &quot;PM10 at %1: %2 ug/m(3)&quot;,
            &quot;data&quot;      : chart
            },
        # This is &quot;downtime&quot; will be used in script.js
             &quot;downtime&quot;  : getDowntime(1)
        })

    return jsonStr;

</code></pre><p>The periodic task which runs in <code>tasks.py</code> will fetching the data from the python api and the webpage, then insert them into the postgres database, so here in 24-hours&rsquo; function we just get them out and fill in the flot picture.</p><h3 id=daily-data>Daily Data</h3><p>Daily data shall be generated via calculating them at the mid-night, that is, at the beginning of a brand new day, we will calculate out the last day&rsquo;s average data.<br>The code is implemented in <code>tasks.py</code> as a crontab task, the code is listed as following:</p><pre><code># Every Day we will run a periodly work which will calculate 
# the average temperature/humidity/pm2.5/pm10 task, and store
# it into the daily database, thus we have to define new Database
# here and insert data into.
# Beijing is locate at east 8 zone, thus 16:12 + 8 hour = 24:12
# At every mid-night(24:12) it will caculate the average value for
# the past 24 hours. 
@periodic_task(run_every=crontab(hour=16, minute=12))
def OneDayHandler():
    # First Get the last 24 hours' data set
    # Local Engine
    # engine = create_engine('postgresql+psycopg2://Trusty:@localhost:5432/mylocaldb',echo=True)
    # Heroku Engine
    db_conn = environ['DATABASE_URL']
    engine = create_engine(db_conn)
    metadata=MetaData(bind=engine)
    # Definition of the weather table
    weather_table=Table('weather',metadata,
    	Column('Insert_Time', DateTime(timezone=True),primary_key=True),
    	Column('Temperature', Integer),
    	Column('Humidity', Integer),
    	Column('PmTen', Integer),
    	Column('PmTwoFive', Integer),
    )
    # Get last 24 records, If we suppose there are truely 24 records in last 24 hours, we can enable this sentense. But sometimes, this will be wrong. 
    s = select([weather_table]).order_by(weather_table.c.Insert_Time.asc()).limit(24)
    conn = engine.connect()
    results = conn.execute(s)

    # Temperature
    totTemperature = 0
    avgTemperature = 0
    # Humidity
    totHumidity = 0
    avgHumidity = 0
    # PM2.5
    totPm25 = 0
    avgPm25 = 0
    # PM10
    totPm10 = 0
    avgPm10 = 0

    records_number = 0 
    for item in results:
        totTemperature += item[1]
        totHumidity += item[2]
        totPm25 += item[4]
        totPm10 += item[3]
        records_number += 1

    if records_number&gt;0:
        avgTemperature = totTemperature/records_number
        avgHumidity = totHumidity/records_number
        avgPm25 = totPm25/records_number
        avgPm10 = totPm10/records_number

    # Definition of the avg_eather table
    avg_metadata = MetaData(bind=engine)
    avg_weather_table=Table('avg_weather',avg_metadata,
    	Column('avg_Insert_Time', DateTime(timezone=True),primary_key=True),
    	Column('avg_Temperature', Integer),
    	Column('avg_Humidity', Integer),
    	Column('avg_PmTen', Integer),
    	Column('avg_PmTwoFive', Integer),
    )
    # Create table in db
    avg_metadata.create_all(checkfirst=True)
    # Create insert sentense
    avg_ins = avg_weather_table.insert()
    # Really insert
    avg_ins = avg_weather_table.insert().values(avg_Insert_Time=datetime.utcnow(), avg_Temperature = avgTemperature, avg_Humidity = avgHumidity, avg_PmTen = avgPm10, avg_PmTwoFive = av
gPm25)
    # Connect to engine and execute
    avg_conn = engine.connect()
    avg_conn.execute(avg_ins)

    return 1

</code></pre><p>We defined a new table named avg_weather, and at the mid-night we will retrieve the latest 24 records, calculating their average value, then insert them into the aver_weather table.</p><h3 id=displaying-daily-data>Displaying Daily Data</h3><p>The main procedure is mainly like in 24-hours datas, but notice we are select from avg_weather, and we only select 7 items.<br>30-days data is very simple, change the day from 7 to 30, then you can see the monthly data.</p><h3 id=write-testing-interface>Write Testing Interface</h3><p>We hope we can manually test the functions via web. So we added following testing APIs in genhtml.py:</p><pre><code>@app.route('/test/fetch/')
def fetch():
    fetch_and_store_data()
    return &quot;Fetching Test Done!!!&quot;;

@app.route('/test/gen/')
def generateOneDay():
    OneDayHandler()
    return &quot;Generate Test Done!!!&quot;;

</code></pre><p>If we visit http://Your_app_address/test/fetch, the program will fetch back the data. And for http://Your_app_address/test/gen, the daily average data will be generated.</p><p>Next Chapter is the last one. We simply paste the screenshots of the APP.</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2014/05/13/write-python-weather-app-on-heroku-12/>Write Python Weather APP on Heroku(12)</a></h1><span class=post-date>May 13, 2014<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=final-effect>Final Effect</h3><p>Following is the final effect of our own app:</p><p><img src=/images/effect_1.jpg alt=/images/effect_1.jpg></p><p><img src=/images/effect_2.jpg alt=/images/effect_2.jpg></p><p><img src=/images/effect_3.jpg alt=/images/effect_3.jpg></p><p>There are lots to be finalize and optimized, but currently It could be ful-fill our requirements which retriving the data and generate the flot.<br>The next series I will try to write some ruby or node.js programs which did the same functionalities, to compare the differencies between app developement.<br>Also to write a web-proxy is a work full of challenge, this will be took as next consideration of developing apps on heroku .</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2014/05/12/write-python-weather-app-on-heroku-9/>Write Python Weather APP on Heroku(9)</a></h1><span class=post-date>May 12, 2014<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=understanding-the-flask-and-jinja>Understanding the flask and Jinja</h3><h4 id=flask-example>Flask Example</h4><p>hello1.py is listed as following:</p><pre><code>from flask import Flask
app = Flask(__name__)

@app.route(&quot;/&quot;)
def index():
    return 'Index Page'

@app.route('/hello')
def hello():
    return &quot;Hello World!&quot;

@app.route('/hello1')
def hello1():
    return &quot;Hello World 1!&quot;

if __name__ == &quot;__main__&quot;:
    app.run()

</code></pre><p>Run this via:</p><pre><code>$ python hello1.py

</code></pre><p>Then use your browser for visiting http://localhost:5000, http://localhost:5000/hello, http://localhost:5000/hello1. You will view different output result.</p><h4 id=jinja-example>Jinja Example</h4><p>The sample.py is listed as following:</p><pre><code># Load the jinja library's namespace into the current module.
import jinja2

# In this case, we will load templates off the filesystem.
# This means we must construct a FileSystemLoader object.
# 
# The search path can be used to make finding templates by
#   relative paths much easier.  In this case, we are using
#   absolute paths and thus set it to the filesystem root.
templateLoader = jinja2.FileSystemLoader( searchpath=&quot;/&quot; )

# An environment provides the data necessary to read and
#   parse our templates.  We pass in the loader object here.
templateEnv = jinja2.Environment( loader=templateLoader )

# This constant string specifies the template file we will use.
TEMPLATE_FILE = &quot;//home/Trusty/code/python/heroku/Jinja2/example1.jinja&quot;

# Read the template file using the environment object.
# This also constructs our Template object.
template = templateEnv.get_template( TEMPLATE_FILE )

# Specify any input variables to the template as a dictionary.
templateVars = { &quot;title&quot; : &quot;Test Example&quot;,
                 &quot;description&quot; : &quot;A simple inquiry of function.&quot; }

# Finally, process the template to produce our final text.
outputText = template.render( templateVars )
print outputText

</code></pre><p>Create the example1.jinja at the corresponding directory, contains following content:</p><pre><code>&lt;!doctype html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot; /&gt;

  &lt;title&gt;{{ title }}&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;{{ description }}&quot; /&gt;
&lt;/head&gt;

&lt;body&gt;

&lt;div id=&quot;content&quot;&gt;
  &lt;p&gt;Why, hello there!&lt;/p&gt;
&lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;

</code></pre><p>Then the result will viewed as following:</p><pre><code>&lt;!doctype html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot; /&gt;

  &lt;title&gt;Test Example&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;A simple inquiry of function.&quot; /&gt;
&lt;/head&gt;

&lt;body&gt;

&lt;div id=&quot;content&quot;&gt;
  &lt;p&gt;Why, hello there!&lt;/p&gt;
&lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;

</code></pre><h3 id=rendering-template-returning>Rendering Template Returning</h3><p>First create the template file under the directory &lsquo;templates&rsquo;, this is the default position for flask for searching the template files:</p><pre><code>$ mkdir templates
$ cat layout.html
&lt;style type=&quot;text/css&quot;&gt;
.metanav
{
    background-color: yellow;
}
&lt;/style&gt;
&lt;div class=&quot;page&quot;&gt;
  &lt;h1&gt;Flaskr&lt;/h1&gt;
  &lt;div class=&quot;metanav&quot;&gt;
  {{ a_random_string }}
  {{ a_random_list[3] }}
  &lt;/div&gt;
&lt;/div&gt;

</code></pre><p>Then in the genhtml.py, we add the following lines for let the template system to rendering our pages:</p><pre><code>from flask import render_template
@app.route('/index')
# Generate the index page, for debugging now
def index():
    # Use template for rendering the content
    rand_list= [0, 1, 2, 3, 4, 5]
    return render_template('layout.html', a_random_string=&quot;Heey, what's up!&quot;, a_random_list=rand_list)

</code></pre><p>Now browser you http://localhost:5000/index, you can see the template rendered result.</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2014/05/11/write-python-weather-app-on-heroku-7/>Write Python Weather APP on Heroku(7)</a></h1><span class=post-date>May 11, 2014<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>We will continue to deploy our tasks on heroku. In this article we will finish the data retriving and database insertion.</p><h3 id=honcho>Honcho</h3><p>Install and Configuration of Honcho:</p><pre><code>$ pip install honcho
# Regenerate requirement.txt and upload it onto heroku
$ mv Procfile ProcfileHoncho
# Edit the new Procfile: 
$ vim Procfile
web: honcho -f ProcfileHoncho start

</code></pre><p>In local, we can also use following command for swiftly verifying our code:</p><pre><code># Because our user belongs to root group, so set following variable firstly
$ export C_FORCE_ROOT=1
$ foreman start

</code></pre><p>Now you can visit http://localhost:5000 for viewing the result.</p><h3 id=taskpy>task.py</h3><p>Following is the script for tasks.py:</p><pre><code>#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Set default encoding: utf-8
import sys;
reload(sys);
# Setting the utf-8 format
sys.setdefaultencoding(&quot;utf8&quot;)


import logging
import string
from celery import Celery
from celery.task import periodic_task
from datetime import datetime,timedelta
from os import environ


# For retrieving temperature/humidity
import pywapi
import urllib2
from urllib2 import ProxyHandler
import re
from BeautifulSoup import BeautifulSoup

# For using database(Postgresql)
# from flash.ext.sqlalchemy import SQLAlchemy
from sqlalchemy import create_engine
from sqlalchemy import MetaData, Column, Table, ForeignKey
from sqlalchemy import Integer, String, DateTime


# redis configuration for celery
### Local, should be change to remote when deploying to heroku
REDIS_URL = environ.get('REDISTOGO_URL', 'redis://localhost')

celery = Celery('tasks', broker=REDIS_URL)

# Fetch 


# Define Periodic Tasks
# @periodic_task(run_every=timedelta(minutes=60))
# Funciton for fetching data and store it in Postgres
def fetch_and_store_data():
    # Fetching the weather information from Yahoo. 
    Yahoo_Result = pywapi.get_weather_from_yahoo('CHXX0099')
    Current_Temp = string.lower(Yahoo_Result['condition']['temp'])
    Current_Humi = string.lower(Yahoo_Result['atmosphere']['humidity'])
    Tomorrow_Forecast = Yahoo_Result['forecasts'][0]
    Twenty_Four_Hours = Yahoo_Result['forecasts'][1]
    Fourty_Eight_Hours = Yahoo_Result['forecasts'][2]
    Seventy_Two_Hours = Yahoo_Result['forecasts'][3]
    # !!! comment proxy related for deploying to heroku !!! #
    proxy = urllib2.ProxyHandler({'http': '192.11.236.225:8000'})
    opener = urllib2.build_opener(proxy)
    urllib2.install_opener(opener)
    page = urllib2.urlopen(&quot;http://www.pm25.in/nanjing&quot;)
    soup = BeautifulSoup(page)                      #
    # Find the detailed table from the soup.        #
    table = soup.find('table', {'id':'detail-data'})#
    # Fetch the XuanWuHu, if not, use MaiGaoQiao ins#tead. 
    rows = table.findAll('tr')                      #
    for subrows in rows:                            #
        if &quot;玄武湖&quot; in subrows.text:                #
            XuanwuLake = subrows                    #
        else:                                       #
            if &quot;迈皋桥&quot; in subrows.text:            #
                XuanwuLake = subrows                #
    XuanwuLake_subitem = XuanwuLake.findAll('td')   #
    # Here we will get an array, fetch out the text #for the content from this array.
    # Fetched origin data, different from cnpm25.cn #
    pm_25_orig = XuanwuLake_subitem[4].text         #
    pm_10_orig = XuanwuLake_subitem[5].text
    # Open the Database
    engine = create_engine('postgresql+psycopg2://Trusty:@localhost:5432/mylocaldb',echo=True)
    metadata=MetaData(bind=engine)
    
    # Definition of the weather table
    weather_table=Table('weather',metadata,
    	Column('Insert_Time', DateTime(timezone=True),primary_key=True),
    	Column('Temperature', Integer),
    	Column('Humidity', Integer),
    	Column('PmTen', Integer),
    	Column('PmTwoFive', Integer),
    )

    # Create the table in mylocaldb
    metadata.create_all(checkfirst=True)

    # Record Insertion
    # First generate an insertion sentense:
    ins = weather_table.insert()
    # Really insert into the Database
    # ins = weather_table.insert().values(Insert_Time=datetime.datetime.utcnow(), Temperature=25, Humidity=75, PmTen=100, PmTwoFive=55)   # Example
    ins = weather_table.insert().values(Insert_Time=datetime.utcnow(), Temperature=Current_Temp, Humidity=Current_Humi, PmTen=int(pm_10_orig), PmTwoFive=int(pm_25_orig))
    # Connect to engine and execute.
    conn = engine.connect()
    result = conn.execute(ins)

    #return Current_Temp
    return pm_25_orig



@periodic_task(run_every=timedelta(seconds=10))
def print_fib():
    #logging.info(fib(30))
    logging.info(&quot;This could be viewed in logging!&quot;)

</code></pre><p>Notice, this version only works in local.<br>For updating the real database on heroku, we have to do some modification on redis server and remove the proxy server, these are the works we need to done in next chapter.</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/2014/05/11/write-python-weather-app-on-heroku-8/>Write Python Weather APP on Heroku(8)</a></h1><span class=post-date>May 11, 2014<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=deploy-on-heroku>Deploy on Heroku</h3><p>The deployed version is listed as following:</p><pre><code>#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Set default encoding: utf-8
import sys;
reload(sys);
# Setting the utf-8 format
sys.setdefaultencoding(&quot;utf8&quot;)

import os
import logging
import string
from celery import Celery
from celery.task import periodic_task
from datetime import datetime,timedelta
from os import environ


# For retrieving temperature/humidity
import pywapi
import urllib2
from urllib2 import ProxyHandler
import re
from BeautifulSoup import BeautifulSoup

# For using database(Postgresql)
# from flash.ext.sqlalchemy import SQLAlchemy
from sqlalchemy import create_engine
from sqlalchemy import MetaData, Column, Table, ForeignKey
from sqlalchemy import Integer, String, DateTime


# redis configuration for celery
### Local, should be change to remote when deploying to heroku
# REDIS_URL = environ.get('REDISTOGO_URL', 'redis://localhost')
### Heroku Ways
REDIS_URL = environ.get('REDISCLOUD_URL')


celery = Celery('tasks', broker=REDIS_URL)

# Fetch 


# Define Periodic Tasks
@periodic_task(run_every=timedelta(minutes=60))
# Funciton for fetching data and store it in Postgres
def fetch_and_store_data():
    # Fetching the weather information from Yahoo. 
    Yahoo_Result = pywapi.get_weather_from_yahoo('CHXX0099')
    Current_Temp = string.lower(Yahoo_Result['condition']['temp'])
    Current_Humi = string.lower(Yahoo_Result['atmosphere']['humidity'])
    Tomorrow_Forecast = Yahoo_Result['forecasts'][0]
    Twenty_Four_Hours = Yahoo_Result['forecasts'][1]
    Fourty_Eight_Hours = Yahoo_Result['forecasts'][2]
    Seventy_Two_Hours = Yahoo_Result['forecasts'][3]
    # !!! comment proxy related for deploying to heroku !!! #
    # proxy = urllib2.ProxyHandler({'http': '1xx.x.xx.xxx:2xxx'})
    # opener = urllib2.build_opener(proxy)
    # urllib2.install_opener(opener)
    # !!! comment out end #
    page = urllib2.urlopen(&quot;http://www.pm25.in/nanjing&quot;)
    soup = BeautifulSoup(page)                      #
    # Find the detailed table from the soup.        #
    table = soup.find('table', {'id':'detail-data'})#
    # Fetch the XuanWuHu, if not, use MaiGaoQiao ins#tead. 
    rows = table.findAll('tr')                      #
    for subrows in rows:                            #
        if &quot;玄武湖&quot; in subrows.text:                #
            XuanwuLake = subrows                    #
        else:                                       #
            if &quot;迈皋桥&quot; in subrows.text:            #
                XuanwuLake = subrows                #
    XuanwuLake_subitem = XuanwuLake.findAll('td')   #
    # Here we will get an array, fetch out the text #for the content from this array.
    # Fetched origin data, different from cnpm25.cn #
    pm_25_orig = XuanwuLake_subitem[4].text         #
    pm_10_orig = XuanwuLake_subitem[5].text
    # Open the Database
    # Local Engine
    # engine = create_engine('postgresql+psycopg2://Trusty:@localhost:5432/mylocaldb',echo=True)
    # Heroku Engine
    db_conn = environ['DATABASE_URL']
    engine = create_engine(db_conn)

    metadata=MetaData(bind=engine)
    
    # Definition of the weather table
    weather_table=Table('weather',metadata,
    	Column('Insert_Time', DateTime(timezone=True),primary_key=True),
    	Column('Temperature', Integer),
    	Column('Humidity', Integer),
    	Column('PmTen', Integer),
    	Column('PmTwoFive', Integer),
    )

    # Create the table in mylocaldb
    metadata.create_all(checkfirst=True)

    # Record Insertion
    # First generate an insertion sentense:
    ins = weather_table.insert()
    # Really insert into the Database
    # ins = weather_table.insert().values(Insert_Time=datetime.datetime.utcnow(), Temperature=25, Humidity=75, PmTen=100, PmTwoFive=55)   # Example
    ins = weather_table.insert().values(Insert_Time=datetime.utcnow(), Temperature=Current_Temp, Humidity=Current_Humi, PmTen=int(pm_10_orig), PmTwoFive=int(pm_25_orig))
    # Connect to engine and execute.
    conn = engine.connect()
    result = conn.execute(ins)

    #return Current_Temp
    return pm_25_orig


# Every 3 minutes we will see debug information, from heroku log
# @periodic_task(run_every=timedelta(minutes=3))
# @periodic_task(run_every=timedelta(seconds=3))
# def print_fib():
#     #logging.info(fib(30))
#     logging.info(&quot;This could be viewed in logging!&quot;)

</code></pre><p>This version use remote service, and it will handle the fetching/updating every 60 minutes.</p><h3 id=prevent-heroku-from-sleeping>Prevent Heroku from Sleeping</h3><p>Register a service at <a href=https://uptimerobot.com/>https://uptimerobot.com/</a>, it will automatically ping or get http(s) service from your web apps.</p><p>Until now, almost all of the back-end has been set up. We can fetch the data and periodly insert into the database, and our web app will continue to run(Never sleep).<br>Tomorrow we will try to write a beautiful front-end for our webapp.</p></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/196/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/196/>196</a></li><li class="page-item active"><a class=page-link href=/page/197/>197</a></li><li class=page-item><a class=page-link href=/page/198/>198</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/244/>244</a></li><li class=page-item><a href=/page/198/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/244/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>