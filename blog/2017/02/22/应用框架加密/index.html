<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>应用框架加密 &middot; Dash</title>

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/poole.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/highlight/googlecode.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="/js/html2canvas.js"></script>
  <script type='text/javascript'>
  function genPostShot() { 
          var rightNow = new Date();
          var imageName = rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");
          imageName += '.jpg'
          html2canvas(document.getElementsByClassName('post'), {
              background :'#FFFFFF',
              onrendered: function(canvas) {
  		
          	$('#test').attr('href', canvas.toDataURL("image/jpeg"));
          	$('#test').attr('download',imageName);
          	$('#test')[0].click();
              }
          });
  }; 
  
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124">
  <link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel="icon">

  
  
  
  
  <meta name="description" content="Encryption of the application frameworks">
  <meta name="keywords" content="Encryption">
  
  
</head>
<body class="theme-base-0c">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <img src="http://purplepalmdash.github.io/images/mylogo.jpeg" alt="gravatar">
      <h1><a href="http://purplepalmdash.github.io/">Get busy living, or get busy dying.</a></h1>
      <a href="http://purplepalmdash.github.io/"><p>Dash</p></a>
    </div>

    <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/post/">All Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/technology/">Technology</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/life/">Life</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/linuxtips/">LinuxTips</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/purplepalmdash"><i class="fa fa-github-square fa-3x"></i></a>
      
      <a href="https://cn.linkedin.com/in/yang-feipeng-1b909319"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://plus.google.com/u/0/106572959364703833986"><i class="fa fa-google-plus-square fa-3x"></i></a>
      <a href="https://www.facebook.com/yang.feipeng"><i class="fa fa-facebook-square fa-3x"></i></a>
      <a href="https://twitter.com/dashwillfly"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      </li>
    </ul>

    

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>应用框架加密</h1>
    <p align="right">
    <a href="javascript:genPostShot()">
	    TurnToJPG --> <i class="fa fa-camera-retro fa-2x"></i>
    </a>
    <a id="test"></a>
    </p>
    <hr>
    <span class="post-date">Feb 22, 2017 
    
    <br/>
    
          <a class="a_cat" href="http://purplepalmdash.github.io/categories/technology">Technology</a>
      
      

    
    </span>
      <div id="_toc" class="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#目的">目的</a></li>
        <li><a href="#测试用框架">测试用框架</a></li>
        <li><a href="#网页服务器">网页服务器</a></li>
        <li><a href="#加密问题">加密问题</a></li>
        <li><a href="#虚拟加密盘">虚拟加密盘</a></li>
        <li><a href="#自动挂载加密盘">自动挂载加密盘</a></li>
        <li><a href="#试图解锁框架">试图解锁框架</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    <h3 id="目的">目的</h3>
<p>在诸如OpenSuse
11.1这一类的古老系统上，对组建系统的加密可能会比较繁琐，首先全盘加密的实现并不容易(几乎不可能，因为内核太古老)。</p>
<h3 id="测试用框架">测试用框架</h3>
<p>为了简单起见，我们将使用一个非常简单的基于C语言的网页服务器，来将我们的静态网站导出，静态网站也没什么内容，大体截图如下:</p>
<p><img src="/images/2017_02_22_09_42_53_811x582.jpg" alt="/images/2017_02_22_09_42_53_811x582.jpg"></p>
<p>框架目录结构如下:</p>
<pre><code>.
├── images
│   └── 2017_02_22_09_41_24_1599x874.jpg
├── index.html
└── index.md

1 directory, 3 files
</code></pre><h3 id="网页服务器">网页服务器</h3>
<p>为了测试的方便，我们用一个基于C实现的静态网页服务器:</p>
<pre><code>$ wget https://gist.githubusercontent.com/sumpygump/9908417/raw/5fa991fda103d0b7a0c38512394a83ccada9ad6c/nweb23.c
$ gcc -O -DLINUX nweb32.c -o nweb
$ ./nweb 8848 ./
</code></pre><p>加入到启动项中:</p>
<pre><code>$ sudo vim /etc/rc.d/boot.local
/home/dash/Code/nweb 8848 /home/dash/testwebsite/ &amp;
</code></pre><p>现在打开浏览器访问该机器的8848端口，可以看到我们的框架已经正确运行:</p>
<p><img src="/images/2017_02_22_10_02_40_784x686.jpg" alt="/images/2017_02_22_10_02_40_784x686.jpg"></p>
<h3 id="加密问题">加密问题</h3>
<p>现在的问题在于：一旦用户登入到系统，对我们框架的结构即可一目了然。</p>
<p>因而首先要解决的是：禁止用户登入进LINUX系统，这个步骤很简单，设置用户名/密码更加复杂就可以，理论上可以防止用户暴力破解并登入系统。</p>
<p>但是一旦用户拔下硬盘，将此机器上的硬盘插入到另一台机器上，则框架的所有结构同样一览无余，接下来我们来解决框架的加密问题.</p>
<h3 id="虚拟加密盘">虚拟加密盘</h3>
<p>创建一个大小为1G的虚拟加密盘raw文件:</p>
<pre><code># dd if=/dev/zero of=/root/luks.vol bs=1M count=1024
1024+0 records in
1024+0 records out
1073741824 bytes (1.1 GB) copied, 9.32633 s, 115 MB/s
</code></pre><p>当11.1系统运行加密的时候，会得到以下错误:</p>
<pre><code># cryptsetup --cipher aes-xts-plain64 --key-size 512 --hash sha512 --iter-time 10000 luksFormat /root/luks.vol 

WARNING!
========
This will overwrite data on /root/luks.vol irrevocably.

Are you sure? (Type uppercase yes): YES
Enter LUKS passphrase: 
Verify passphrase: 
Command failed: Unable to obtain sector size for /root/luks.vol
</code></pre><p>而在12.3系统上，则加密成功,猜想应该是cryptsetup版本的问题:</p>
<pre><code> # cryptsetup --cipher aes-xts-plain64 --key-size 512 --hash sha512 --iter-time 10000 luksFormat /root/luks.vol

WARNING!
========
This will overwrite data on /root/luks.vol irrevocably.

Are you sure? (Type uppercase yes): YES
Enter LUKS passphrase: 
Verify passphrase: 
</code></pre><h3 id="自动挂载加密盘">自动挂载加密盘</h3>
<p>自动挂在加密盘可以通过keyfile来进行，创建一个用于解锁加密raw文件的keyfile的步骤如下:</p>
<pre><code># dd if=/dev/urandom of=/root/file_key bs=512 count=8
8+0 records in
8+0 records out
4096 bytes (4.1 kB) copied, 0.000364836 s, 11.2 MB/s
# cryptsetup -v luksAddKey /root/luks.vol /root/file_key
Enter any passphrase: 
Key slot 0 unlocked.
Command successful.
</code></pre><p>创建一个用于挂载加密raw文件的位置:</p>
<pre><code># mkdir -p /media/vol
</code></pre><p>用keyfile解锁并挂载到<code>/media/vol</code>:</p>
<pre><code># cryptsetup -v luksOpen /root/luks.vol vol_crypt --key-file=/root/file_key
# mkfs.ext4 /dev/mapper/vol_crypt
# mount /dev/mapper/vol_crypt /media/vol
</code></pre><p>查看是否被挂载成功:</p>
<pre><code># df -h | grep crypt
/dev/mapper/vol_crypt 1006M   18M  938M   2% /media/vol
</code></pre><p>将框架拷贝入加密目录:</p>
<pre><code># cp -r testwebsite/ /media/vol/
# cp /root/nweb /media/vol/
</code></pre><p>现在在OpenSuse的自启动文件中添加以下条目，用于自动解锁及开机时自动运行框架:</p>
<pre><code># vim /etc/rc.d/boot.local
cryptsetup -v luksOpen /root/luks.vol vol_crypt --key-file=/root/file_key
mount /dev/mapper/vol_crypt /media/vol
/media/vol/nweb 8848 /media/vol/testwebsite/ &amp;
</code></pre><p>重新启动机器，验证结果:</p>
<pre><code># ps -ef | grep nweb
root      1980     1  0 21:52 ?        00:00:00 /media/vol/nweb 8848 /media/vol/testwebsite/
root      1983  1876  0 21:52 pts/0    00:00:00 grep --color=auto nweb
</code></pre><p>打开浏览器，可以看到该框架已经被正确运行, 而这一次框架的可执行文件位于加密磁盘里。</p>
<h3 id="试图解锁框架">试图解锁框架</h3>
<p>前面说过，如果用户能登入系统，则框架对用户来说完全可见，不存在加密的问题。所以第一步应该是阻止用户登录入系统.</p>
<p>如果用户得到虚拟机磁盘，挂载到另一台机器上：</p>
<p><img src="/images/2017_02_22_11_10_13_606x347.jpg" alt="/images/2017_02_22_11_10_13_606x347.jpg"></p>
<p>启动后检查磁盘的挂载情况, 可以看到40G 大小的OpenSuse12.3系统盘已经被挂载上:</p>
<pre><code>$ sudo fdisk -l /dev/vdb
Disk /dev/vdb: 40 GiB, 42949672960 bytes, 83886080 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x0000bea3

Device     Boot    Start      End  Sectors  Size Id Type
/dev/vdb1           2048  4208639  4206592    2G 82 Linux swap / Solaris
/dev/vdb2  *     4208640 36403199 32194560 15.4G 83 Linux
/dev/vdb3       36403200 83886079 47482880 22.7G 83 Linux
</code></pre><p><code>/dev/vdb2</code>为OpenSuse 12.3的系统盘，我们挂载一下，并检查<code>/media/vol</code>里的内容:</p>
<pre><code># mount /dev/vdb2 /mnt1
# ls /mnt1
bin  boot  dev  encryption  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  selinux  srv  sys  tmp  usr  var
# ls /mnt1/media/vol/
</code></pre><p>可以看到此挂载目录下框架内容完全不可见，而此时如果硬行查看<code>/root/luks.vol</code>文件，只能看到乱码.</p>
<p>解密加密后的raw文件的关键在于拿到keyfile,
而我们的keyfile位于<code>/root/keyfile</code>，理论上还是存在被解密的可能。为了保密起见，可以考虑将此keyfile置于可移动介质中，或者云端。</p>

  </div>
  
</div>






<script src="http://purplepalmdash.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

